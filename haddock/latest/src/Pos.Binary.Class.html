<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DataKinds            #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators        #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-cpp">#include &quot;MachDeps.h&quot;</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# OPTIONS_GHC -Wno-redundant-constraints #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-- | Serialization-related types</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#encode"><span class="hs-identifier hs-var">encode</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#encodeStrict"><span class="hs-identifier hs-var">encodeStrict</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#decode"><span class="hs-identifier hs-var">decode</span></a><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#decodeOrFail"><span class="hs-identifier hs-var">decodeOrFail</span></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#decodeFull"><span class="hs-identifier hs-var">decodeFull</span></a><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-comment">-- * Different sizes for ints</span><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#UnsignedVarInt"><span class="hs-identifier hs-type">UnsignedVarInt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#SignedVarInt"><span class="hs-identifier hs-type">SignedVarInt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Binary.Class.html#FixedSizeInt"><span class="hs-identifier hs-type">FixedSizeInt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Get</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Put</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Binary</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Get</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteOffset</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getByteString</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>                                              </span><span class="hs-identifier hs-var">getLazyByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runGet</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>                                              </span><span class="hs-identifier hs-var">runGetOrFail</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Put</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putCharUtf8</span><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>                                              </span><span class="hs-identifier hs-var">putLazyByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putWord8</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runPut</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSL</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Hashable</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Hashable</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HS</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Microsecond</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Millisecond</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Generic</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">G</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Generic</span><span class="hs-operator">.</span><span class="hs-identifier">Mutable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GM</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Word</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ErrorMessage</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TypeError</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Memory</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Byte</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromBytes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toBytes</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>                   </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putByteString</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- Bi typeclass</span><span>
</span><a name="line-51"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-- | Simplified definition of serializable object,</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- Data.Binary.Class-alike.</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- Write @instance Bi SomeType where@ without any method definitions if you</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- want to use the 'Binary' instance for your type.</span><span>
</span><a name="line-58"></a><span class="hs-keyword">class</span><span> </span><a name="Bi"><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier">Bi</span></a></a><span> </span><a name="local-6989586621679190052"><a href="#local-6989586621679190052"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-identifier">put</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-keyword">default</span><span> </span><span class="hs-identifier">put</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-61"></a><span>    </span><a name="local-8214565720323964946"><a href="Pos.Binary.Class.html#put"><span class="hs-identifier">put</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Binary</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">put</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-pragma">{-# INLINE put #-}</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span>    </span><span class="hs-identifier">get</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-keyword">default</span><span> </span><span class="hs-identifier">get</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679190052"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-66"></a><span>    </span><a name="local-8214565720323964947"><a href="Pos.Binary.Class.html#get"><span class="hs-identifier">get</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Binary</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-pragma">{-# INLINE get #-}</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">--instance Serializable t =&gt; B.Binary t where</span><span>
</span><a name="line-70"></a><span class="hs-comment">--    get = get</span><span>
</span><a name="line-71"></a><span class="hs-comment">--    put = put</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | Encode a value to a lazy bytestring</span><span>
</span><a name="line-74"></a><span class="hs-identifier">encode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679190064"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679190064"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LByteString</span><span>
</span><a name="line-75"></a><a name="encode"><a href="Pos.Binary.Class.html#encode"><span class="hs-identifier">encode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Binary.Class.html#put"><span class="hs-identifier hs-var">put</span></a><span>
</span><a name="line-76"></a><span class="hs-pragma">{-# INLINE encode #-}</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | Encode a value to a strict bytestring.  Use with caution, because</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- converting to strict ByteString is expensive.</span><span>
</span><a name="line-80"></a><span class="hs-identifier">encodeStrict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679190063"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679190063"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-81"></a><a name="encodeStrict"><a href="Pos.Binary.Class.html#encodeStrict"><span class="hs-identifier">encodeStrict</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">toStrict</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Pos.Binary.Class.html#encode"><span class="hs-identifier hs-var">encode</span></a><span>
</span><a name="line-82"></a><span class="hs-pragma">{-# INLINE encodeStrict #-}</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">-- | Decode a value from a lazy ByteString, reconstructing the</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- original structure.</span><span>
</span><a name="line-86"></a><span class="hs-identifier">decode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679190062"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679190062"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-87"></a><a name="decode"><a href="Pos.Binary.Class.html#decode"><span class="hs-identifier">decode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runGet</span><span> </span><a href="Pos.Binary.Class.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-identifier">decodeOrFail</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679190061"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-91"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LByteString</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteOffset</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LByteString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ByteOffset</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679190061"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><a name="decodeOrFail"><a href="Pos.Binary.Class.html#decodeOrFail"><span class="hs-identifier">decodeOrFail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runGetOrFail</span><span> </span><a href="Pos.Binary.Class.html#get"><span class="hs-identifier hs-var">get</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- | Like 'decode', but ensures that the whole input has been consumed.</span><span>
</span><a name="line-97"></a><span class="hs-identifier">decodeFull</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679190060"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">LByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><a href="#local-6989586621679190060"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-98"></a><a name="decodeFull"><a href="Pos.Binary.Class.html#decodeFull"><span class="hs-identifier">decodeFull</span></a></a><span> </span><a name="local-6989586621679190065"><a href="#local-6989586621679190065"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runGetOrFail</span><span> </span><a href="Pos.Binary.Class.html#get"><span class="hs-identifier hs-var">get</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679190065"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679190066"><a href="#local-6989586621679190066"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;decodeFull: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679190066"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679190067"><a href="#local-6989586621679190067"><span class="hs-identifier">unconsumed</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679190068"><a href="#local-6989586621679190068"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">BSL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679190067"><span class="hs-identifier hs-var">unconsumed</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679190068"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-102"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;decodeFull: unconsumed input&quot;</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- Variable-sized numbers</span><span>
</span><a name="line-106"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- Copied from Edward Kmett's 'bytes' library (licensed under BSD3)</span><span>
</span><a name="line-109"></a><span class="hs-identifier">putUnsignedVarInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621679190059"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bits</span><span> </span><a href="#local-6989586621679190059"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679190059"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-110"></a><a name="putUnsignedVarInt"><a href="Pos.Binary.Class.html#putUnsignedVarInt"><span class="hs-identifier">putUnsignedVarInt</span></a></a><span> </span><a name="local-6989586621679190069"><a href="#local-6989586621679190069"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679190069"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0x80</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putWord8</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679190069"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-113"></a><span>          </span><span class="hs-identifier hs-var">putWord8</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">setBit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679190069"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">7</span><span>
</span><a name="line-114"></a><span>          </span><a href="Pos.Binary.Class.html#putUnsignedVarInt"><span class="hs-identifier hs-var">putUnsignedVarInt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">shiftR</span><span> </span><a href="#local-6989586621679190069"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">7</span><span>
</span><a name="line-115"></a><span class="hs-pragma">{-# INLINE putUnsignedVarInt #-}</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier">getUnsignedVarInt'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679190058"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bits</span><span> </span><a href="#local-6989586621679190058"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679190058"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-118"></a><a name="getUnsignedVarInt%27"><a href="Pos.Binary.Class.html#getUnsignedVarInt%27"><span class="hs-identifier">getUnsignedVarInt'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679190070"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-120"></a><span>    </span><a name="local-6989586621679190070"><a href="#local-6989586621679190070"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679190071"><a href="#local-6989586621679190071"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">testBit</span><span> </span><a href="#local-6989586621679190071"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">7</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>             </span><a name="local-6989586621679190072"><a href="#local-6989586621679190072"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621679190070"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-122"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">shiftL</span><span> </span><a href="#local-6989586621679190072"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-number">7</span><span> </span><span class="hs-operator hs-var">.|.</span><span> </span><span class="hs-identifier hs-var">clearBit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679190071"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">7</span><span>
</span><a name="line-123"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679190071"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-124"></a><span class="hs-pragma">{-# INLINE getUnsignedVarInt' #-}</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-identifier">putSignedVarInt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier hs-type">ZZEncode</span></a><span> </span><a href="#local-6989586621679190056"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679190057"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Integral</span><span> </span><a href="#local-6989586621679190057"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bits</span><span> </span><a href="#local-6989586621679190057"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679190056"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-127"></a><a name="putSignedVarInt"><a href="Pos.Binary.Class.html#putSignedVarInt"><span class="hs-identifier">putSignedVarInt</span></a></a><span> </span><a name="local-6989586621679190073"><a href="#local-6989586621679190073"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.Class.html#putUnsignedVarInt"><span class="hs-identifier hs-var">putUnsignedVarInt</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#zzEncode"><span class="hs-identifier hs-var">zzEncode</span></a><span> </span><a href="#local-6989586621679190073"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-pragma">{-# INLINE putSignedVarInt #-}</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">getSignedVarInt'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier hs-type">ZZEncode</span></a><span> </span><a href="#local-6989586621679190054"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679190055"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span> </span><a href="#local-6989586621679190055"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bits</span><span> </span><a href="#local-6989586621679190055"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679190054"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-131"></a><a name="getSignedVarInt%27"><a href="Pos.Binary.Class.html#getSignedVarInt%27"><span class="hs-identifier">getSignedVarInt'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Binary.Class.html#zzDecode"><span class="hs-identifier hs-var">zzDecode</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pos.Binary.Class.html#getUnsignedVarInt%27"><span class="hs-identifier hs-var">getUnsignedVarInt'</span></a><span>
</span><a name="line-132"></a><span class="hs-pragma">{-# INLINE getSignedVarInt' #-}</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- | Turn a signed number into an unsigned one.</span><span>
</span><a name="line-135"></a><span class="hs-comment">--</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- &gt;&gt;&gt; (zzEncode (-3), zzEncode 3)</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- (5, 6)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">class</span><span> </span><a name="ZZEncode"><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier">ZZEncode</span></a></a><span> </span><a name="local-6989586621679190050"><a href="#local-6989586621679190050"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679190051"><a href="#local-6989586621679190051"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-identifier">zzEncode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190050"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679190051"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-140"></a><span>    </span><span class="hs-identifier">zzDecode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190051"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679190050"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- Copied from the 'protobuf' library (licensed under BSD3)</span><span>
</span><a name="line-143"></a><span class="hs-keyword">instance</span><span> </span><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier hs-type">ZZEncode</span></a><span> </span><span class="hs-identifier hs-type">Int32</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-144"></a><span>    </span><a name="local-8214565720323964943"><a href="Pos.Binary.Class.html#zzEncode"><span class="hs-identifier">zzEncode</span></a></a><span> </span><a name="local-6989586621679190178"><a href="#local-6989586621679190178"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679190178"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679190178"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">31</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-pragma">{-# INLINE zzEncode #-}</span><span>
</span><a name="line-146"></a><span>    </span><a name="local-8214565720323964944"><a href="Pos.Binary.Class.html#zzDecode"><span class="hs-identifier">zzDecode</span></a></a><span> </span><a name="local-6989586621679190179"><a href="#local-6989586621679190179"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190179"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span>
</span><a name="line-147"></a><span>                     </span><span class="hs-identifier hs-var">negate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190179"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-pragma">{-# INLINE zzDecode #-}</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-keyword">instance</span><span> </span><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier hs-type">ZZEncode</span></a><span> </span><span class="hs-identifier hs-type">Int64</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-151"></a><span>    </span><a name="local-8214565720323964943"><a href="Pos.Binary.Class.html#zzEncode"><span class="hs-identifier">zzEncode</span></a></a><span> </span><a name="local-6989586621679190176"><a href="#local-6989586621679190176"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679190176"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679190176"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">63</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-pragma">{-# INLINE zzEncode #-}</span><span>
</span><a name="line-153"></a><span>    </span><a name="local-8214565720323964944"><a href="Pos.Binary.Class.html#zzDecode"><span class="hs-identifier">zzDecode</span></a></a><span> </span><a name="local-6989586621679190177"><a href="#local-6989586621679190177"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190177"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span>
</span><a name="line-154"></a><span>                     </span><span class="hs-identifier hs-var">negate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190177"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>    </span><span class="hs-pragma">{-# INLINE zzDecode #-}</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-keyword">instance</span><span> </span><a href="Pos.Binary.Class.html#ZZEncode"><span class="hs-identifier hs-type">ZZEncode</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-158"></a><span class="hs-cpp">#if (WORD_SIZE_IN_BITS == 32)</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-identifier">zzEncode</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">x</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">xor</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">31</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span class="hs-cpp">#elif (WORD_SIZE_IN_BITS == 64)</span><span>
</span><a name="line-161"></a><span>    </span><a name="local-8214565720323964943"><a href="Pos.Binary.Class.html#zzEncode"><span class="hs-identifier">zzEncode</span></a></a><span> </span><a name="local-6989586621679190174"><a href="#local-6989586621679190174"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679190174"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftL</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679190174"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">63</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-pragma">{-# INLINE zzEncode #-}</span><span>
</span><a name="line-163"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-164"></a><span class="hs-cpp"># error Unsupported platform</span><span>
</span><a name="line-165"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-166"></a><span>    </span><a name="local-8214565720323964944"><a href="Pos.Binary.Class.html#zzDecode"><span class="hs-identifier">zzDecode</span></a></a><span> </span><a name="local-6989586621679190175"><a href="#local-6989586621679190175"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190175"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xor</span><span class="hs-special">`</span><span>
</span><a name="line-167"></a><span>                     </span><span class="hs-identifier hs-var">negate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679190175"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-pragma">{-# INLINE zzDecode #-}</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- Int/Word encoding</span><span>
</span><a name="line-172"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-keyword">newtype</span><span> </span><a name="UnsignedVarInt"><a href="Pos.Binary.Class.html#UnsignedVarInt"><span class="hs-identifier">UnsignedVarInt</span></a></a><span> </span><a name="local-6989586621679190049"><a href="#local-6989586621679190049"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="UnsignedVarInt"><a href="Pos.Binary.Class.html#UnsignedVarInt"><span class="hs-identifier">UnsignedVarInt</span></a></a><span> </span><span class="hs-special">{</span><a name="getUnsignedVarInt"><a href="Pos.Binary.Class.html#getUnsignedVarInt"><span class="hs-identifier">getUnsignedVarInt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190049"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">}</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NFData</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span class="hs-keyword">newtype</span><span> </span><a name="SignedVarInt"><a href="Pos.Binary.Class.html#SignedVarInt"><span class="hs-identifier">SignedVarInt</span></a></a><span> </span><a name="local-6989586621679190048"><a href="#local-6989586621679190048"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SignedVarInt"><a href="Pos.Binary.Class.html#SignedVarInt"><span class="hs-identifier">SignedVarInt</span></a></a><span> </span><span class="hs-special">{</span><a name="getSignedVarInt"><a href="Pos.Binary.Class.html#getSignedVarInt"><span class="hs-identifier">getSignedVarInt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190048"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NFData</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span class="hs-keyword">newtype</span><span> </span><a name="FixedSizeInt"><a href="Pos.Binary.Class.html#FixedSizeInt"><span class="hs-identifier">FixedSizeInt</span></a></a><span> </span><a name="local-6989586621679190047"><a href="#local-6989586621679190047"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FixedSizeInt"><a href="Pos.Binary.Class.html#FixedSizeInt"><span class="hs-identifier">FixedSizeInt</span></a></a><span> </span><span class="hs-special">{</span><a name="getFixedSizeInt"><a href="Pos.Binary.Class.html#getFixedSizeInt"><span class="hs-identifier">getFixedSizeInt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679190047"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">}</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NFData</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">TypeError</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-special">(</span><span class="hs-char">'Text &quot;Do not encode 'Int' directly. Instead, use one of newtype wrappers:&quot; ':$$:
     'Text &quot;  'FixedSizeInt': always uses 8 bytes&quot; ':$$:
     'Text &quot;  'SignedVarInt': uses 1&#8211;10 bytes (1 byte for &#8722;64..63)&quot; ':$$:
     'Text &quot;  'UnsignedVarInt': uses 1&#8211;10 bytes (1 byte for 0..127);&quot; ':$$:
     'Text &quot;                    more efficient for non-negative numbers,&quot; ':$$:
     'Text &quot;                    but takes 10 bytes for negative numbers&quot;)
  =&gt; Bi Int
  where
    get = panic &quot;get@Int&quot;
    put = panic &quot;put@Int&quot;

instance TypeError
    ('Text &quot;Do not encode 'Word' directly. Instead, use one of newtype wrappers:&quot; ':$$:
     'Text &quot;  'FixedSizeInt': always uses 8 bytes&quot; ':$$:
     'Text &quot;  'UnsignedVarInt': uses 1&#8211;10 bytes (1 byte for 0..127)&quot;)
  =&gt; Bi Word
  where
    get = panic &quot;get@Word&quot;
    put = panic &quot;put@Word&quot;

-- Int

instance Bi (UnsignedVarInt Int) where
    put (UnsignedVarInt a) = putUnsignedVarInt (fromIntegral a :: Word)
    {-# INLINE put #-}
    get = UnsignedVarInt . (fromIntegral :: Word -&gt; Int) &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

instance Bi (SignedVarInt Int) where
    put (SignedVarInt a) = putSignedVarInt a
    {-# INLINE put #-}
    get = SignedVarInt &lt;$&gt; getSignedVarInt'
    {-# INLINE get #-}

instance Bi (FixedSizeInt Int) where
    put (FixedSizeInt a) = Binary.put a
    {-# INLINE put #-}
    get = FixedSizeInt &lt;$&gt; Binary.get
    {-# INLINE get #-}

-- Int64

instance Bi (UnsignedVarInt Int64) where
    put (UnsignedVarInt a) = putUnsignedVarInt (fromIntegral a :: Word64)
    {-# INLINE put #-}
    get = UnsignedVarInt . (fromIntegral :: Word64 -&gt; Int64) &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

instance Bi (SignedVarInt Int64) where
    put (SignedVarInt a) = putSignedVarInt a
    {-# INLINE put #-}
    get = SignedVarInt &lt;$&gt; getSignedVarInt'
    {-# INLINE get #-}

instance Bi (FixedSizeInt Int64) where
    put (FixedSizeInt a) = Binary.put a
    {-# INLINE put #-}
    get = FixedSizeInt &lt;$&gt; Binary.get
    {-# INLINE get #-}

-- Word

instance Bi (UnsignedVarInt Word) where
    put (UnsignedVarInt a) = putUnsignedVarInt a
    {-# INLINE put #-}
    get = UnsignedVarInt &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

instance Bi (FixedSizeInt Word) where
    put (FixedSizeInt a) = Binary.put a
    {-# INLINE put #-}
    get = FixedSizeInt &lt;$&gt; Binary.get
    {-# INLINE get #-}

-- Word16

instance Bi (UnsignedVarInt Word16) where
    put (UnsignedVarInt a) = putUnsignedVarInt a
    {-# INLINE put #-}
    get = UnsignedVarInt &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

-- Word32

instance Bi (UnsignedVarInt Word32) where
    put (UnsignedVarInt a) = putUnsignedVarInt a
    {-# INLINE put #-}
    get = UnsignedVarInt &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

-- Word64

instance Bi (UnsignedVarInt Word64) where
    put (UnsignedVarInt a) = putUnsignedVarInt a
    {-# INLINE put #-}
    get = UnsignedVarInt &lt;$&gt; getUnsignedVarInt'
    {-# INLINE get #-}

----------------------------------------------------------------------------
-- Popular basic instances
----------------------------------------------------------------------------

-- TODO get rid of boilerplate (or rewrite by hands to make it more clear)
-- I just copied most of it from here:
-- https://hackage.haskell.org/package/binary-0.8.4.1/docs/src/Data.Binary.Class.html#line-564

{-
Copyright (c) Lennart Kolmodin

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
   notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
   notice, this list of conditions and the following disclaimer in the
   documentation and/or other materials provided with the distribution.

3. Neither the name of the author nor the names of his contributors
   may be used to endorse or promote products derived from this software
   without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE CONTRIBUTORS ``AS IS'' AND ANY EXPRESS
OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED.  IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
-}

----------------------------------------------------------------------------
-- Primitive types
----------------------------------------------------------------------------

instance Bi () where
    put ()  = mempty
    get     = return ()

instance Bi Bool where
    put     = putWord8 . fromIntegral . fromEnum
    get     = getWord8 &gt;&gt;= toBool
      where
        toBool 0 = return False
        toBool 1 = return True
        toBool c = fail (&quot;Could not map value &quot; ++ show c ++ &quot; to Bool&quot;)

instance Bi Char where
    {-# INLINE put #-}
    put = putCharUtf8
    get = do
        let getByte = liftM (fromIntegral :: Word8 -&gt; Int) get
            shiftL6 = flip shiftL 6 :: Int -&gt; Int
        w &lt;- getByte
        r &lt;- case () of
                _ | w &lt; 0x80  -&gt; return w
                  | w &lt; 0xe0  -&gt; do
                                    x &lt;- liftM (xor 0x80) getByte
                                    return (x .|. shiftL6 (xor 0xc0 w))
                  | w &lt; 0xf0  -&gt; do
                                    x &lt;- liftM (xor 0x80) getByte
                                    y &lt;- liftM (xor 0x80) getByte
                                    return (y .|. shiftL6 (x .|. shiftL6
                                            (xor 0xe0 w)))
                  | otherwise -&gt; do
                                x &lt;- liftM (xor 0x80) getByte
                                y &lt;- liftM (xor 0x80) getByte
                                z &lt;- liftM (xor 0x80) getByte
                                return (z .|. shiftL6 (y .|. shiftL6
                                        (x .|. shiftL6 (xor 0xf0 w))))
        getChr r
      where
        getChr w
          | w &lt;= 0x10ffff = return $! toEnum $ fromEnum w
          | otherwise = fail &quot;Not a valid Unicode code point!&quot;

----------------------------------------------------------------------------
-- Numeric data
----------------------------------------------------------------------------

-- These instances just copy 'Binary'

instance Bi Integer            -- TODO: write how Integer is serialized

instance Bi Int16              -- 2 bytes, big endian
instance Bi Int32              -- 4 bytes, big endian
instance Bi Int64              -- 8 bytes, big endian

instance Bi Word8              -- single byte
instance Bi Word16             -- 2 bytes, big endian
instance Bi Word32             -- 4 bytes, big endian
instance Bi Word64             -- 8 bytes, big endian

----------------------------------------------------------------------------
-- Containers
----------------------------------------------------------------------------

instance (Bi a, Bi b) =&gt; Bi (a, b) where
    {-# INLINE put #-}
    put (a, b) = put a &lt;&gt; put b
    {-# INLINE get #-}
    get = liftM2 (,) get get

instance (Bi a, Bi b, Bi c) =&gt; Bi (a, b, c) where
    {-# INLINE put #-}
    put (a, b, c) = put a &lt;&gt; put b &lt;&gt; put c
    {-# INLINE get #-}
    get = liftM3 (,,) get get get

instance (Bi a, Bi b, Bi c, Bi d) =&gt; Bi (a, b, c, d) where
    {-# INLINE put #-}
    put (a, b, c, d) = put a &lt;&gt; put b &lt;&gt; put c &lt;&gt; put d
    {-# INLINE get #-}
    get = liftM4 (,,,) get get get get

instance Bi ByteString where
    put bs = put (UnsignedVarInt (BS.length bs)) &lt;&gt; putByteString bs
    get = do
        UnsignedVarInt n &lt;- get
        getByteString n

instance Bi LByteString where
    put bs = put (UnsignedVarInt (BSL.length bs)) &lt;&gt; putLazyByteString bs
    get = do
        UnsignedVarInt n &lt;- get
        getLazyByteString n

instance Bi Text where
    put t = put (T.encodeUtf8 t)
    get = do
        bs &lt;- get
        case T.decodeUtf8' bs of
            Left e  -&gt; fail (show e)
            Right a -&gt; return a

instance Bi a =&gt; Bi [a] where
    put xs = put (UnsignedVarInt (length xs)) &lt;&gt; mapM_ put xs
    get = do UnsignedVarInt n &lt;- get
             getMany (n :: Int)

-- | 'getMany n' get 'n' elements in order, without blowing the stack.
getMany :: Bi a =&gt; Int -&gt; Get [a]
getMany n = go [] n
 where
    go xs 0 = return $! reverse xs
    go xs i = do x &lt;- get
                 -- we must seq x to avoid stack overflows due to laziness in
                 -- (&gt;&gt;=)
                 x `seq` go (x:xs) (i-1)
{-# INLINE getMany #-}

instance (Bi a, Bi b) =&gt; Bi (Either a b) where
    put (Left  a) = putWord8 0 &lt;&gt; put a
    put (Right b) = putWord8 1 &lt;&gt; put b
    get = do
        w &lt;- getWord8
        case w of
            0 -&gt; liftM Left  get
            _ -&gt; liftM Right get

instance Bi a =&gt; Bi (NonEmpty a) where
    get = maybe (fail &quot;Empty list&quot;) pure . nonEmpty =&lt;&lt; get
    put = put . toList

instance (Bi a) =&gt; Bi (Maybe a) where
    put Nothing  = putWord8 0
    put (Just x) = putWord8 1 &lt;&gt; put x
    get = do
        w &lt;- getWord8
        case w of
            0 -&gt; return Nothing
            _ -&gt; liftM Just get

instance (Hashable k, Eq k, Bi k, Bi v) =&gt; Bi (HM.HashMap k v) where
    get = fmap HM.fromList get
    put = put . HM.toList

instance (Hashable k, Eq k, Bi k) =&gt; Bi (HashSet k) where
    get = fmap HS.fromList get
    put = put . HS.toList

-- Copy-pasted w/ modifications, license:
-- https://github.com/bos/vector-binary-instances/blob/master/LICENSE

instance Bi a =&gt; Bi (V.Vector a) where
    get = do
        UnsignedVarInt n &lt;- get
        v &lt;- pure $ unsafePerformIO $ GM.unsafeNew n
        let go 0 = return ()
            go i = do
                x &lt;- get
                () &lt;- pure $ unsafePerformIO $ GM.unsafeWrite v (n-i) x
                go (i-1)
        () &lt;- go n
        pure $ unsafePerformIO $ G.unsafeFreeze v
    put v = do
        put (UnsignedVarInt (G.length v))
        G.mapM_ put v

instance Bi Void where
    put = absurd
    get = mzero

----------------------------------------------------------------------------
-- Other types
----------------------------------------------------------------------------

instance Bi Millisecond where
    put = put . toInteger
    get = fromInteger &lt;$&gt; get

instance Bi Microsecond where
    put = put . toInteger
    get = fromInteger &lt;$&gt; get

instance Bi Byte where
    put = put . toBytes
    get = fromBytes &lt;$&gt; get
</span></pre></body></html>