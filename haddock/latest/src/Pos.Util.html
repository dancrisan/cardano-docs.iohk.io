<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveTraversable   #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">-- | Miscellaneous unclassified utility functions.</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>         </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>
</span><a name="line-12"></a><span>       </span><span class="hs-comment">-- * Stuff for testing and benchmarking</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Arbitrary</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">TimeLimit</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-comment">-- * Various</span><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#mappendPair"><span class="hs-identifier hs-var">mappendPair</span></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#mconcatPair"><span class="hs-identifier hs-var">mconcatPair</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Pos.Util.html#%3C%2F%2F%3E"><span class="hs-operator hs-var">&lt;//&gt;</span></a><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readerToState"><span class="hs-identifier hs-var">readerToState</span></a><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#eitherPanic"><span class="hs-identifier hs-var">eitherPanic</span></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#inAssertMode"><span class="hs-identifier hs-var">inAssertMode</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#diffDoubleMap"><span class="hs-identifier hs-var">diffDoubleMap</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#maybeThrow%27"><span class="hs-identifier hs-var">maybeThrow'</span></a><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-comment">-- * NonEmpty</span><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#NE"><span class="hs-identifier hs-type">NE</span></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#neZipWith3"><span class="hs-identifier hs-var">neZipWith3</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>       </span><span class="hs-comment">-- * Chronological sequences</span><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#NewestFirst"><span class="hs-identifier hs-type">NewestFirst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#OldestFirst"><span class="hs-identifier hs-type">OldestFirst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#toNewestFirst"><span class="hs-identifier hs-var">toNewestFirst</span></a><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#toOldestFirst"><span class="hs-identifier hs-var">toOldestFirst</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>       </span><span class="hs-comment">-- * Lenses</span><span>
</span><a name="line-37"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#makeLensesData"><span class="hs-identifier hs-var">makeLensesData</span></a><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neHead"><span class="hs-identifier hs-var">_neHead</span></a><span>
</span><a name="line-39"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neTail"><span class="hs-identifier hs-var">_neTail</span></a><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neLast"><span class="hs-identifier hs-var">_neLast</span></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span>       </span><span class="hs-comment">-- * LRU</span><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#clearLRU"><span class="hs-identifier hs-var">clearLRU</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#spanSafe"><span class="hs-identifier hs-var">spanSafe</span></a><span>
</span><a name="line-46"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#eitherToVerRes"><span class="hs-identifier hs-var">eitherToVerRes</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>       </span><span class="hs-comment">-- * Concurrency</span><span>
</span><a name="line-49"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#clearMVar"><span class="hs-identifier hs-var">clearMVar</span></a><span>
</span><a name="line-50"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#forcePutMVar"><span class="hs-identifier hs-var">forcePutMVar</span></a><span>
</span><a name="line-51"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readMVarConditional"><span class="hs-identifier hs-var">readMVarConditional</span></a><span>
</span><a name="line-52"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readUntilEqualMVar"><span class="hs-identifier hs-var">readUntilEqualMVar</span></a><span>
</span><a name="line-53"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readTVarConditional"><span class="hs-identifier hs-var">readTVarConditional</span></a><span>
</span><a name="line-54"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readUntilEqualTVar"><span class="hs-identifier hs-var">readUntilEqualTVar</span></a><span>
</span><a name="line-55"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withReadLifted"><span class="hs-identifier hs-var">withReadLifted</span></a><span>
</span><a name="line-56"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withWriteLifted"><span class="hs-identifier hs-var">withWriteLifted</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>       </span><span class="hs-comment">-- * Instances</span><span>
</span><a name="line-59"></a><span>       </span><span class="hs-comment">-- ** MonadFail (Either s), assuming IsString s</span><span>
</span><a name="line-60"></a><span>       </span><span class="hs-comment">-- ** MonadFail ParsecT</span><span>
</span><a name="line-61"></a><span>       </span><span class="hs-comment">-- ** MonadFail Dialog</span><span>
</span><a name="line-62"></a><span>       </span><span class="hs-comment">-- ** MonadFail Transfer</span><span>
</span><a name="line-63"></a><span>       </span><span class="hs-comment">-- ** MonadFail TimedIO</span><span>
</span><a name="line-64"></a><span>       </span><span class="hs-comment">-- ** MonadFail ResponseT</span><span>
</span><a name="line-65"></a><span>       </span><span class="hs-comment">-- ** MonadFail LoggerNameBox</span><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Arrow</span><span>                    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">***</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">ReadWriteLock</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RWLock</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">acquireRead</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">acquireWrite</span><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                                                   </span><span class="hs-identifier hs-var">releaseRead</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">releaseWrite</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span class="hs-operator">.</span><span class="hs-identifier">TVar</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readTVar</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Each</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lensRules</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeWrapped</span><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                                                   </span><span class="hs-identifier hs-var">_Wrapped</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">FieldTH</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeFieldOpticsForDec</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fail</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">retry</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Resource</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResourceT</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Binary</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Cache</span><span class="hs-operator">.</span><span class="hs-identifier">LRU</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LRU</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Hashable</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">span</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith3</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">SafeCopy</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SafeCopy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">base</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">contain</span><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>                                                   </span><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safeGet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safePut</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Exts</span><span>                         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IL</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Mockable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Throw</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VerificationRes</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LoggerNameBox</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">QuickCheck</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Arbitrary</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Parsec</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ParsecT</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>                        </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cancel</span><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>                                                   </span><span class="hs-identifier hs-var">finally</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">waitAny</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Unsafe</span><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeInit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeLast</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- SafeCopy instance for HashMap</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">AcidState</span><span>               </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bi</span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.Arbitrary.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Arbitrary</span></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.NotImplemented.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">NotImplemented</span></a><span>          </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">TimeLimit</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-identifier">mappendPair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679167230"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679167231"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679167230"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679167231"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679167230"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679167231"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679167230"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679167231"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><a name="mappendPair"><a href="Pos.Util.html#mappendPair"><span class="hs-identifier">mappendPair</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">***</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mappend</span><span> </span><span class="hs-operator hs-var">***</span><span> </span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-identifier">mconcatPair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679167228"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679167229"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679167228"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679167229"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679167228"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679167229"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><a name="mconcatPair"><a href="Pos.Util.html#mconcatPair"><span class="hs-identifier">mconcatPair</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="Pos.Util.html#mappendPair"><span class="hs-identifier hs-var">mappendPair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">-- | Concatenates two url part using regular slash '/'.</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- E.g. @&quot;./dir/&quot; &lt;//&gt; &quot;/file&quot; = &quot;./dir/file&quot;@.</span><span>
</span><a name="line-114"></a><span class="hs-special">(</span><span class="hs-operator">&lt;//&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-115"></a><span class="hs-special">(</span><a name="%3C%2F%2F%3E"><a href="Pos.Util.html#%3C%2F%2F%3E"><span class="hs-operator">&lt;//&gt;</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679167243"><a href="#local-6989586621679167243"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621679167244"><a href="#local-6989586621679167244"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679167246"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679167247"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-117"></a><span>    </span><a name="local-6989586621679167245"><a href="#local-6989586621679167245"><span class="hs-identifier">isSlash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'/'</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>    </span><a name="local-6989586621679167246"><a href="#local-6989586621679167246"><span class="hs-identifier">lhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><a href="#local-6989586621679167245"><span class="hs-identifier hs-var">isSlash</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621679167243"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621679167247"><a href="#local-6989586621679167247"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><a href="#local-6989586621679167245"><span class="hs-identifier hs-var">isSlash</span></a><span> </span><a href="#local-6989586621679167244"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- | Convert (Reader s) to any (MonadState s)</span><span>
</span><a name="line-122"></a><span class="hs-identifier">readerToState</span><span>
</span><a name="line-123"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="#local-6989586621679167180"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679167181"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-124"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Reader</span><span> </span><a href="#local-6989586621679167180"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679167182"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679167181"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679167182"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-125"></a><a name="readerToState"><a href="Pos.Util.html#readerToState"><span class="hs-identifier">readerToState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runReader</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-char">'base ''VerificationRes

-- | A helper for simple error handling in executables
eitherPanic :: Show a =&gt; Text -&gt; Either a b -&gt; b
eitherPanic msgPrefix = either (panic . (msgPrefix &lt;&gt;) . show) identity

-- | This function performs checks at compile-time for different actions.
-- May slowdown implementation. To disable such checks (especially in benchmarks)
-- one should compile with: @stack build --flag cardano-sl:-asserts@
inAssertMode :: Applicative m =&gt; m a -&gt; m ()
#ifdef ASSERTS_ON
inAssertMode x = x *&gt; pure ()
#else
inAssertMode _ = pure ()
#endif
{-# INLINE inAssertMode #-}

-- | Remove elements which are in 'b' from 'a'
diffDoubleMap
    :: forall k1 k2 v.
       (Eq k1, Eq k2, Hashable k1, Hashable k2)
    =&gt; HashMap k1 (HashMap k2 v)
    -&gt; HashMap k1 (HashMap k2 v)
    -&gt; HashMap k1 (HashMap k2 v)
diffDoubleMap a b = HM.foldlWithKey' go mempty a
  where
    go :: HashMap k1 (HashMap k2 v)
       -&gt; k1
       -&gt; HashMap k2 v
       -&gt; HashMap k1 (HashMap k2 v)
    go res extKey internalMap =
        case HM.lookup extKey b of
            Nothing -&gt; HM.insert extKey internalMap res
            Just internalMapB -&gt;
                let diff = internalMap `HM.difference` internalMapB
                in if null diff
                       then res
                       else HM.insert extKey diff res

maybeThrow' :: (Mockable Throw m, Exception e) =&gt; e -&gt; Maybe a -&gt; m a
maybeThrow' e = maybe (throw e) pure

----------------------------------------------------------------------------
-- NonEmpty
----------------------------------------------------------------------------

type NE = NonEmpty

neZipWith3 :: (x -&gt; y -&gt; z -&gt; q) -&gt; NonEmpty x -&gt; NonEmpty y -&gt; NonEmpty z -&gt; NonEmpty q
neZipWith3 f (x :| xs) (y :| ys) (z :| zs) = f x y z :| zipWith3 f xs ys zs

-- | Makes a span on the list, considering tail only. Predicate has
-- list head as first argument. Used to take non-null prefix that
-- depends on the first element.
spanSafe :: (a -&gt; a -&gt; Bool) -&gt; NonEmpty a -&gt; (NonEmpty a, [a])
spanSafe p (x:|xs) = let (a,b) = span (p x) xs in (x:|a,b)

----------------------------------------------------------------------------
-- Chronological sequences
----------------------------------------------------------------------------

newtype NewestFirst f a = NewestFirst {getNewestFirst :: f a}
  deriving (Eq, Ord, Show,
            Functor, Foldable, Traversable,
            Container, NontrivialContainer,
            Binary, Bi,
            Arbitrary)
newtype OldestFirst f a = OldestFirst {getOldestFirst :: f a}
  deriving (Eq, Ord, Show,
            Functor, Foldable, Traversable,
            Container, NontrivialContainer,
            Binary, Bi,
            Arbitrary)

makeWrapped ''NewestFirst
makeWrapped ''OldestFirst

instance Each (f a) (f b) a b =&gt;
         Each (NewestFirst f a) (NewestFirst f b) a b where
    each = _Wrapped . each
instance Each (f a) (f b) a b =&gt;
         Each (OldestFirst f a) (OldestFirst f b) a b where
    each = _Wrapped . each

instance One (f a) =&gt; One (NewestFirst f a) where
    type OneItem (NewestFirst f a) = OneItem (f a)
    one = NewestFirst . one
instance One (f a) =&gt; One (OldestFirst f a) where
    type OneItem (OldestFirst f a) = OneItem (f a)
    one = OldestFirst . one

instance IL.IsList (f a) =&gt; IL.IsList (NewestFirst f a) where
    type Item (NewestFirst f a) = IL.Item (f a)
    toList = IL.toList . getNewestFirst
    fromList = NewestFirst . IL.fromList

instance IL.IsList (f a) =&gt; IL.IsList (OldestFirst f a) where
    type Item (OldestFirst f a) = IL.Item (f a)
    toList = IL.toList . getOldestFirst
    fromList = OldestFirst . IL.fromList

class Chrono f where
    toNewestFirst :: OldestFirst f a -&gt; NewestFirst f a
    toOldestFirst :: NewestFirst f a -&gt; OldestFirst f a

instance Chrono [] where
    toNewestFirst = NewestFirst . reverse . getOldestFirst
    toOldestFirst = OldestFirst . reverse . getNewestFirst

instance Chrono NonEmpty where
    toNewestFirst = NewestFirst . NE.reverse . getOldestFirst
    toOldestFirst = OldestFirst . NE.reverse . getNewestFirst

----------------------------------------------------------------------------
-- Lens utils
----------------------------------------------------------------------------

-- | Make lenses for a data family instance.
makeLensesData :: TH.Name -&gt; TH.Name -&gt; TH.DecsQ
makeLensesData familyName typeParamName = do
    info &lt;- TH.reify familyName
    ins &lt;- case info of
        TH.FamilyI _ ins -&gt; return ins
        _                -&gt; fail &quot;makeLensesIndexed: expected data family name&quot;
    typeParamInfo &lt;- TH.reify typeParamName
    typeParam &lt;- case typeParamInfo of
        TH.TyConI dec -&gt; decToType dec
        _             -&gt; fail &quot;makeLensesIndexed: expected a type&quot;
    let mbInsDec = find ((== Just typeParam) . getTypeParam) ins
    case mbInsDec of
        Nothing -&gt; fail (&quot;makeLensesIndexed: an instance for &quot; ++
                         TH.nameBase typeParamName ++ &quot; not found&quot;)
        Just insDec -&gt; makeFieldOpticsForDec lensRules insDec
  where
    getTypeParam (TH.NewtypeInstD _ _ [t] _ _ _) = Just t
    getTypeParam (TH.DataInstD    _ _ [t] _ _ _) = Just t
    getTypeParam _                               = Nothing

    decToType (TH.DataD    _ n _ _ _ _) = return (TH.ConT n)
    decToType (TH.NewtypeD _ n _ _ _ _) = return (TH.ConT n)
    decToType other                     =
        fail (&quot;makeLensesIndexed: decToType failed on: &quot; ++ show other)

-- | Lens for the head of 'NonEmpty'.
--
-- We can't use '_head' because it doesn't work for 'NonEmpty':
-- &lt;https://github.com/ekmett/lens/issues/636#issuecomment-213981096&gt;.
-- Even if we could though, it wouldn't be a lens, only a traversal.
_neHead :: Lens' (NonEmpty a) a
_neHead f (x :| xs) = (:| xs) &lt;$&gt; f x

-- | Lens for the tail of 'NonEmpty'.
_neTail :: Lens' (NonEmpty a) [a]
_neTail f (x :| xs) = (x :|) &lt;$&gt; f xs

-- | Lens for the last element of 'NonEmpty'.
_neLast :: Lens' (NonEmpty a) a
_neLast f (x :| []) = (:| []) &lt;$&gt; f x
_neLast f (x :| xs) = (\y -&gt; x :| unsafeInit xs ++ [y]) &lt;$&gt; f (unsafeLast xs)

----------------------------------------------------------------------------
-- LRU cache
----------------------------------------------------------------------------

-- | Remove all items from LRU, retaining maxSize property.
clearLRU :: Ord k =&gt; LRU.LRU k v -&gt; LRU.LRU k v
clearLRU = LRU.newLRU . LRU.maxSize

-- [SRK-51]: Probably this instance should be in @safecopy@ library
instance (Ord k, SafeCopy k, SafeCopy v) =&gt;
         SafeCopy (LRU.LRU k v) where
    getCopy = contain $ LRU.fromList &lt;$&gt; safeGet &lt;*&gt; safeGet
    putCopy lru =
        contain $
        do safePut $ LRU.maxSize lru
           safePut $ LRU.toList lru
    errorTypeName _ = &quot;LRU&quot;

----------------------------------------------------------------------------
-- Deserialized wrapper
----------------------------------------------------------------------------

eitherToVerRes :: Either Text a -&gt; VerificationRes
eitherToVerRes (Left errors) = if T.null errors then VerFailure []
                               else VerFailure $ T.split (==';') errors
eitherToVerRes (Right _ )    = VerSuccess


instance IsString s =&gt; MonadFail (Either s) where
    fail = Left . fromString

instance MonadFail (ParsecT s u m) where
    fail = Monad.fail

deriving instance MonadFail m =&gt; MonadFail (LoggerNameBox m)

instance MonadFail m =&gt; MonadFail (ResourceT m) where
    fail = lift . fail

----------------------------------------------------------------------------
-- Concurrency utilites (MVar/TVar/RWLock..)
----------------------------------------------------------------------------

clearMVar :: MonadIO m =&gt; MVar a -&gt; m ()
clearMVar = liftIO . void . tryTakeMVar

forcePutMVar :: MonadIO m =&gt; MVar a -&gt; a -&gt; m ()
forcePutMVar mvar val = do
    res &lt;- liftIO $ tryPutMVar mvar val
    unless res $ do
        _ &lt;- liftIO $ tryTakeMVar mvar
        forcePutMVar mvar val

-- | Block until value in MVar satisfies given predicate. When value
-- satisfies, it is returned.
readMVarConditional :: (MonadIO m) =&gt; (x -&gt; Bool) -&gt; MVar x -&gt; m x
readMVarConditional predicate mvar = do
    rData &lt;- liftIO . readMVar $ mvar -- first we try to read for optimization only
    if predicate rData then pure rData
    else do
        tData &lt;- liftIO . takeMVar $ mvar -- now take data
        if predicate tData then do -- check again
            _ &lt;- liftIO $ tryPutMVar mvar tData -- try to put taken value
            pure tData
        else
            readMVarConditional predicate mvar

-- | Read until value is equal to stored value comparing by some function.
readUntilEqualMVar
    :: (Eq a, MonadIO m)
    =&gt; (x -&gt; a) -&gt; MVar x -&gt; a -&gt; m x
readUntilEqualMVar f mvar expVal = readMVarConditional ((expVal ==) . f) mvar

-- | Block until value in TVar satisfies given predicate. When value
-- satisfies, it is returned.
readTVarConditional :: (MonadIO m) =&gt; (x -&gt; Bool) -&gt; TVar x -&gt; m x
readTVarConditional predicate tvar = atomically $ do
    res &lt;- readTVar tvar
    if predicate res then pure res
    else retry

-- | Read until value is equal to stored value comparing by some function.
readUntilEqualTVar
    :: (Eq a, MonadIO m)
    =&gt; (x -&gt; a) -&gt; TVar x -&gt; a -&gt; m x
readUntilEqualTVar f tvar expVal = readTVarConditional ((expVal ==) . f) tvar

withReadLifted :: (MonadIO m, MonadMask m) =&gt; RWLock -&gt; m a -&gt; m a
withReadLifted l = bracket_ (liftIO $ acquireRead l) (liftIO $ releaseRead l)

withWriteLifted :: (MonadIO m, MonadMask m) =&gt; RWLock -&gt; m a -&gt; m a
withWriteLifted l = bracket_ (liftIO $ acquireWrite l) (liftIO $ releaseWrite l)
</span></pre></body></html>