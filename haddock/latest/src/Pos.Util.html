<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ConstraintKinds     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DeriveTraversable   #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">-- | Miscellaneous unclassified utility functions.</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-15"></a><span>       </span><span class="hs-comment">-- * Stuff for testing and benchmarking</span><span>
</span><a name="line-16"></a><span>         </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Arbitrary</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-comment">-- * Various</span><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#Raw"><span class="hs-identifier hs-type">Raw</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readerToState"><span class="hs-identifier hs-var">readerToState</span></a><span>
</span><a name="line-21"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#eitherPanic"><span class="hs-identifier hs-var">eitherPanic</span></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#inAssertMode"><span class="hs-identifier hs-var">inAssertMode</span></a><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#diffDoubleMap"><span class="hs-identifier hs-var">diffDoubleMap</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#getKeys"><span class="hs-identifier hs-var">getKeys</span></a><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#maybeThrow"><span class="hs-identifier hs-var">maybeThrow</span></a><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#maybeThrow%27"><span class="hs-identifier hs-var">maybeThrow'</span></a><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-comment">-- * Lists</span><span>
</span><a name="line-29"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#allDistinct"><span class="hs-identifier hs-var">allDistinct</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span>       </span><span class="hs-comment">-- * NonEmpty</span><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#NE"><span class="hs-identifier hs-type">NE</span></a><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#neZipWith3"><span class="hs-identifier hs-var">neZipWith3</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>       </span><span class="hs-comment">-- * Chronological sequences</span><span>
</span><a name="line-36"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#NewestFirst"><span class="hs-identifier hs-type">NewestFirst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#OldestFirst"><span class="hs-identifier hs-type">OldestFirst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#toNewestFirst"><span class="hs-identifier hs-var">toNewestFirst</span></a><span>
</span><a name="line-39"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#toOldestFirst"><span class="hs-identifier hs-var">toOldestFirst</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>       </span><span class="hs-comment">-- * SafeCopy</span><span>
</span><a name="line-42"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#getCopyBinary"><span class="hs-identifier hs-var">getCopyBinary</span></a><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#putCopyBinary"><span class="hs-identifier hs-var">putCopyBinary</span></a><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span>       </span><span class="hs-comment">-- * Lenses</span><span>
</span><a name="line-46"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#makeLensesData"><span class="hs-identifier hs-var">makeLensesData</span></a><span>
</span><a name="line-47"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#magnify%27"><span class="hs-identifier hs-var">magnify'</span></a><span>
</span><a name="line-48"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neHead"><span class="hs-identifier hs-var">_neHead</span></a><span>
</span><a name="line-49"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neTail"><span class="hs-identifier hs-var">_neTail</span></a><span>
</span><a name="line-50"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#_neLast"><span class="hs-identifier hs-var">_neLast</span></a><span>
</span><a name="line-51"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#zoom%27"><span class="hs-identifier hs-var">zoom'</span></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>       </span><span class="hs-comment">-- * Prettification</span><span>
</span><a name="line-54"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Color</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#colorize"><span class="hs-identifier hs-var">colorize</span></a><span>
</span><a name="line-56"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withColoredMessages"><span class="hs-identifier hs-var">withColoredMessages</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>       </span><span class="hs-comment">-- * TimeWarp helpers</span><span>
</span><a name="line-59"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#CanLogInParallel"><span class="hs-identifier hs-type">CanLogInParallel</span></a><span>
</span><a name="line-60"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#WaitingDelta"><span class="hs-identifier hs-type">WaitingDelta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#logWarningLongAction"><span class="hs-identifier hs-var">logWarningLongAction</span></a><span>
</span><a name="line-62"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#logWarningWaitOnce"><span class="hs-identifier hs-var">logWarningWaitOnce</span></a><span>
</span><a name="line-63"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#logWarningWaitLinear"><span class="hs-identifier hs-var">logWarningWaitLinear</span></a><span>
</span><a name="line-64"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#logWarningWaitInf"><span class="hs-identifier hs-var">logWarningWaitInf</span></a><span>
</span><a name="line-65"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#runWithRandomIntervals%27"><span class="hs-identifier hs-var">runWithRandomIntervals'</span></a><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#waitRandomInterval%27"><span class="hs-identifier hs-var">waitRandomInterval'</span></a><span>
</span><a name="line-67"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#runWithRandomIntervals"><span class="hs-identifier hs-var">runWithRandomIntervals</span></a><span>
</span><a name="line-68"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#runWithRandomIntervalsNow"><span class="hs-identifier hs-var">runWithRandomIntervalsNow</span></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#waitRandomInterval"><span class="hs-identifier hs-var">waitRandomInterval</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>       </span><span class="hs-comment">-- * LRU</span><span>
</span><a name="line-72"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#clearLRU"><span class="hs-identifier hs-var">clearLRU</span></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>       </span><span class="hs-comment">-- * Binary serialization</span><span>
</span><a name="line-75"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#AsBinary"><span class="hs-identifier hs-type">AsBinary</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#AsBinaryClass"><span class="hs-identifier hs-type">AsBinaryClass</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#fromBinaryM"><span class="hs-identifier hs-var">fromBinaryM</span></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#spanSafe"><span class="hs-identifier hs-var">spanSafe</span></a><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#eitherToVerRes"><span class="hs-identifier hs-var">eitherToVerRes</span></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>       </span><span class="hs-comment">-- * MVar</span><span>
</span><a name="line-83"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#clearMVar"><span class="hs-identifier hs-var">clearMVar</span></a><span>
</span><a name="line-84"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#forcePutMVar"><span class="hs-identifier hs-var">forcePutMVar</span></a><span>
</span><a name="line-85"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readMVarConditional"><span class="hs-identifier hs-var">readMVarConditional</span></a><span>
</span><a name="line-86"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readUntilEqualMVar"><span class="hs-identifier hs-var">readUntilEqualMVar</span></a><span>
</span><a name="line-87"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readTVarConditional"><span class="hs-identifier hs-var">readTVarConditional</span></a><span>
</span><a name="line-88"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#readUntilEqualTVar"><span class="hs-identifier hs-var">readUntilEqualTVar</span></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#stubListenerOneMsg"><span class="hs-identifier hs-var">stubListenerOneMsg</span></a><span>
</span><a name="line-91"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#stubListenerConv"><span class="hs-identifier hs-var">stubListenerConv</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withWaitLogConv"><span class="hs-identifier hs-var">withWaitLogConv</span></a><span>
</span><a name="line-94"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withWaitLogConvL"><span class="hs-identifier hs-var">withWaitLogConvL</span></a><span>
</span><a name="line-95"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#withWaitLog"><span class="hs-identifier hs-var">withWaitLog</span></a><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#convWithTimeLimit"><span class="hs-identifier hs-var">convWithTimeLimit</span></a><span>
</span><a name="line-97"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#sendActionsWithTimeLimit"><span class="hs-identifier hs-var">sendActionsWithTimeLimit</span></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#execWithTimeLimit"><span class="hs-identifier hs-var">execWithTimeLimit</span></a><span>
</span><a name="line-100"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#parseIntegralSafe"><span class="hs-identifier hs-var">parseIntegralSafe</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#NamedMessagePart"><span class="hs-identifier hs-type">NamedMessagePart</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>       </span><span class="hs-comment">-- * Instances</span><span>
</span><a name="line-104"></a><span>       </span><span class="hs-comment">-- ** Lift Byte</span><span>
</span><a name="line-105"></a><span>       </span><span class="hs-comment">-- ** FromJSON Byte</span><span>
</span><a name="line-106"></a><span>       </span><span class="hs-comment">-- ** ToJSON Byte</span><span>
</span><a name="line-107"></a><span>       </span><span class="hs-comment">-- ** SafeCopy (NonEmpty a)</span><span>
</span><a name="line-108"></a><span>       </span><span class="hs-comment">-- ** SafeCopy Microsecond</span><span>
</span><a name="line-109"></a><span>       </span><span class="hs-comment">-- ** SafeCopy Millisecond</span><span>
</span><a name="line-110"></a><span>       </span><span class="hs-comment">-- ** MonadFail (Either s), assuming IsString s</span><span>
</span><a name="line-111"></a><span>       </span><span class="hs-comment">-- ** MonadFail ParsecT</span><span>
</span><a name="line-112"></a><span>       </span><span class="hs-comment">-- ** MonadFail Dialog</span><span>
</span><a name="line-113"></a><span>       </span><span class="hs-comment">-- ** MonadFail Transfer</span><span>
</span><a name="line-114"></a><span>       </span><span class="hs-comment">-- ** MonadFail TimedIO</span><span>
</span><a name="line-115"></a><span>       </span><span class="hs-comment">-- ** MonadFail ResponseT</span><span>
</span><a name="line-116"></a><span>       </span><span class="hs-comment">-- ** MonadFail LoggerNameBox</span><span>
</span><a name="line-117"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span class="hs-operator">.</span><span class="hs-identifier">TVar</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readTVar</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Each</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LensLike'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Magnified</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Zoomed</span><span class="hs-special">,</span><span>
</span><a name="line-121"></a><span>                                                </span><span class="hs-identifier hs-var">lensRules</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">magnify</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeWrapped</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zoom</span><span class="hs-special">,</span><span>
</span><a name="line-122"></a><span>                                                </span><span class="hs-identifier hs-var">_Wrapped</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">FieldTH</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeFieldOpticsForDec</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fail</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">retry</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Resource</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ResourceT</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FromJSON</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ToJSON</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Binary</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Cache</span><span class="hs-operator">.</span><span class="hs-identifier">LRU</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LRU</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Hashable</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashSet</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMap</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">span</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith3</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Proxy</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">asProxyTypeOf</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">SafeCopy</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Contained</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SafeCopy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">base</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">contain</span><span class="hs-special">,</span><span>
</span><a name="line-137"></a><span>                                                </span><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safeGet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safePut</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Serialize</span><span>                </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Cereal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Get</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Put</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Microsecond</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Millisecond</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Second</span><span class="hs-special">,</span><span>
</span><a name="line-141"></a><span>                                                </span><span class="hs-identifier hs-var">convertUnit</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shown</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>
</span><a name="line-144"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Syntax</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Lift</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Syntax</span><span>
</span><a name="line-146"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Mockable</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Delay</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fork</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Mockable</span><span class="hs-special">,</span><span>
</span><a name="line-147"></a><span>                                                </span><span class="hs-identifier hs-type">Throw</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cancel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">delay</span><span class="hs-special">,</span><span>
</span><a name="line-148"></a><span>                                                </span><span class="hs-identifier hs-var">finally</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fork</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">killThread</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throw</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">waitAny</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Node</span><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ConversationActions</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-150"></a><span>                                                </span><span class="hs-identifier hs-type">ListenerAction</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Message</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NodeId</span><span class="hs-special">,</span><span>
</span><a name="line-151"></a><span>                                                </span><span class="hs-identifier hs-type">SendActions</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Node</span><span class="hs-operator">.</span><span class="hs-identifier">Message</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MessageName</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Packable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Unpackable</span><span class="hs-special">,</span><span>
</span><a name="line-153"></a><span>                                                </span><span class="hs-identifier hs-var">messageName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">messageName'</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">read</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Memory</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Byte</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromBytes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toBytes</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VerificationRes</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Console</span><span class="hs-operator">.</span><span class="hs-identifier">ANSI</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Color</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ColorIntensity</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Vivid</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-158"></a><span>                                                </span><span class="hs-identifier hs-type">ConsoleLayer</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Foreground</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-159"></a><span>                                                </span><span class="hs-identifier hs-type">SGR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reset</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SetColor</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setSGRCode</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LoggerNameBox</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WithLogger</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logDebug</span><span class="hs-special">,</span><span>
</span><a name="line-161"></a><span>                                                </span><span class="hs-identifier hs-var">logWarning</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">modifyLoggerName</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Test</span><span class="hs-operator">.</span><span class="hs-identifier">QuickCheck</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Arbitrary</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Parsec</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ParsecT</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Parsec</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">digit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">many1</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Parsec</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Parser</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>                     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">async</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cancel</span><span class="hs-special">,</span><span>
</span><a name="line-167"></a><span>                                                </span><span class="hs-identifier hs-var">finally</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">waitAny</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Unsafe</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeInit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeLast</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">-- SafeCopy instance for HashMap</span><span>
</span><a name="line-171"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">AcidState</span><span class="hs-operator">.</span><span class="hs-identifier">Instances</span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>              </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Pos.Binary.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Bi</span><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Crypto.Random.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Crypto.Random.html#randomNumber"><span class="hs-identifier hs-var">randomNumber</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.Arbitrary.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Arbitrary</span></a><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.NotImplemented.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">NotImplemented</span></a><span>       </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-comment">-- | Helper class used for Pos.Util.Relay</span><span>
</span><a name="line-180"></a><span class="hs-keyword">class</span><span> </span><a name="NamedMessagePart"><a href="Pos.Util.html#NamedMessagePart"><span class="hs-identifier">NamedMessagePart</span></a></a><span> </span><a name="local-6989586621679298070"><a href="#local-6989586621679298070"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-identifier">nMessageName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621679298070"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- | A wrapper over 'ByteString' for adding type safety to</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- 'Pos.Crypto.Pki.encryptRaw' and friends.</span><span>
</span><a name="line-185"></a><span class="hs-keyword">newtype</span><span> </span><a name="Raw"><a href="Pos.Util.html#Raw"><span class="hs-identifier">Raw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Raw"><a href="Pos.Util.html#Raw"><span class="hs-identifier">Raw</span></a></a><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- | A helper for &quot;Data.SafeCopy&quot; that creates 'putCopy' given a 'Binary'</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- instance.</span><span>
</span><a name="line-190"></a><span class="hs-identifier">putCopyBinary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679298133"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679298133"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Contained</span><span> </span><span class="hs-identifier hs-type">Cereal</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Put</span><span>
</span><a name="line-191"></a><a name="putCopyBinary"><a href="Pos.Util.html#putCopyBinary"><span class="hs-identifier">putCopyBinary</span></a></a><span> </span><a name="local-6989586621679298134"><a href="#local-6989586621679298134"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">contain</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">safePut</span><span> </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#encode"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">encode</span></a><span> </span><a href="#local-6989586621679298134"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | A helper for &quot;Data.SafeCopy&quot; that creates 'getCopy' given a 'Binary'</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- instance.</span><span>
</span><a name="line-195"></a><span class="hs-identifier">getCopyBinary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="#local-6989586621679298132"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Contained</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Cereal</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679298132"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><a name="getCopyBinary"><a href="Pos.Util.html#getCopyBinary"><span class="hs-identifier">getCopyBinary</span></a></a><span> </span><a name="local-6989586621679298135"><a href="#local-6989586621679298135"><span class="hs-identifier">typeName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">contain</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-197"></a><span>    </span><a name="local-6989586621679298136"><a href="#local-6989586621679298136"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">safeGet</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Pos.Binary.Class.html#decodeFull"><span class="hs-identifier hs-var">Bi</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">decodeFull</span></a><span> </span><a href="#local-6989586621679298136"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679298137"><a href="#local-6989586621679298137"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;getCopy@&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679298135"><span class="hs-identifier hs-var">typeName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679298137"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679298138"><a href="#local-6989586621679298138"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679298138"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">-- | Convert (Reader s) to any (MonadState s)</span><span>
</span><a name="line-203"></a><span class="hs-identifier">readerToState</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="#local-6989586621679298071"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679298072"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-205"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Reader</span><span> </span><a href="#local-6989586621679298071"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679298073"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679298072"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679298073"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-206"></a><a name="readerToState"><a href="Pos.Util.html#readerToState"><span class="hs-identifier">readerToState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runReader</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-char">'base ''VerificationRes

-- | A helper for simple error handling in executables
eitherPanic :: Show a =&gt; Text -&gt; Either a b -&gt; b
eitherPanic msgPrefix = either (panic . (msgPrefix &lt;&gt;) . show) identity

-- | This function performs checks at compile-time for different actions.
-- May slowdown implementation. To disable such checks (especially in benchmarks)
-- one should compile with: @stack build --flag cardano-sl:-asserts@
inAssertMode :: Applicative m =&gt; m a -&gt; m ()
#ifdef ASSERTS_ON
inAssertMode x = x *&gt; pure ()
#else
inAssertMode _ = pure ()
#endif
{-# INLINE inAssertMode #-}

-- | Remove elements which are in 'b' from 'a'
diffDoubleMap
    :: forall k1 k2 v.
       (Eq k1, Eq k2, Hashable k1, Hashable k2)
    =&gt; HashMap k1 (HashMap k2 v)
    -&gt; HashMap k1 (HashMap k2 v)
    -&gt; HashMap k1 (HashMap k2 v)
diffDoubleMap a b = HM.foldlWithKey' go mempty a
  where
    go :: HashMap k1 (HashMap k2 v)
       -&gt; k1
       -&gt; HashMap k2 v
       -&gt; HashMap k1 (HashMap k2 v)
    go res extKey internalMap =
        case HM.lookup extKey b of
            Nothing -&gt; HM.insert extKey internalMap res
            Just internalMapB -&gt;
                let diff = internalMap `HM.difference` internalMapB
                in if null diff
                       then res
                       else HM.insert extKey diff res

maybeThrow :: (MonadThrow m, Exception e) =&gt; e -&gt; Maybe a -&gt; m a
maybeThrow e = maybe (throwM e) pure

maybeThrow' :: (Mockable Throw m, Exception e) =&gt; e -&gt; Maybe a -&gt; m a
maybeThrow' e = maybe (throw e) pure

----------------------------------------------------------------------------
-- List utils
----------------------------------------------------------------------------

allDistinct :: Ord a =&gt; [a] -&gt; Bool
allDistinct xs = and $ zipWith (/=) sorted (drop 1 sorted)
  where
    sorted = sort xs

----------------------------------------------------------------------------
-- NonEmpty
----------------------------------------------------------------------------

type NE = NonEmpty

neZipWith3 :: (x -&gt; y -&gt; z -&gt; q) -&gt; NonEmpty x -&gt; NonEmpty y -&gt; NonEmpty z -&gt; NonEmpty q
neZipWith3 f (x :| xs) (y :| ys) (z :| zs) = f x y z :| zipWith3 f xs ys zs

----------------------------------------------------------------------------
-- Chronological sequences
----------------------------------------------------------------------------

newtype NewestFirst f a = NewestFirst {getNewestFirst :: f a}
  deriving (Eq, Ord, Show,
            Functor, Foldable, Traversable,
            Container, NontrivialContainer,
            Binary, Bi,
            Arbitrary)
newtype OldestFirst f a = OldestFirst {getOldestFirst :: f a}
  deriving (Eq, Ord, Show,
            Functor, Foldable, Traversable,
            Container, NontrivialContainer,
            Binary, Bi,
            Arbitrary)

makeWrapped ''NewestFirst
makeWrapped ''OldestFirst

instance Each (f a) (f b) a b =&gt;
         Each (NewestFirst f a) (NewestFirst f b) a b where
    each = _Wrapped . each
instance Each (f a) (f b) a b =&gt;
         Each (OldestFirst f a) (OldestFirst f b) a b where
    each = _Wrapped . each

instance One (f a) =&gt; One (NewestFirst f a) where
    type OneItem (NewestFirst f a) = OneItem (f a)
    one = NewestFirst . one
instance One (f a) =&gt; One (OldestFirst f a) where
    type OneItem (OldestFirst f a) = OneItem (f a)
    one = OldestFirst . one

class Chrono f where
    toNewestFirst :: OldestFirst f a -&gt; NewestFirst f a
    toOldestFirst :: NewestFirst f a -&gt; OldestFirst f a

instance Chrono [] where
    toNewestFirst = NewestFirst . reverse . getOldestFirst
    toOldestFirst = OldestFirst . reverse . getNewestFirst

instance Chrono NonEmpty where
    toNewestFirst = NewestFirst . NE.reverse . getOldestFirst
    toOldestFirst = OldestFirst . NE.reverse . getNewestFirst

----------------------------------------------------------------------------
-- Lens utils
----------------------------------------------------------------------------

-- | Make lenses for a data family instance.
makeLensesData :: Name -&gt; Name -&gt; DecsQ
makeLensesData familyName typeParamName = do
    info &lt;- reify familyName
    ins &lt;- case info of
        FamilyI _ ins -&gt; return ins
        _             -&gt; fail &quot;makeLensesIndexed: expected data family name&quot;
    typeParamInfo &lt;- reify typeParamName
    typeParam &lt;- case typeParamInfo of
        TyConI dec -&gt; decToType dec
        _          -&gt; fail &quot;makeLensesIndexed: expected a type&quot;
    let mbInsDec = find ((== Just typeParam) . getTypeParam) ins
    case mbInsDec of
        Nothing -&gt; fail (&quot;makeLensesIndexed: an instance for &quot; ++
                         nameBase typeParamName ++ &quot; not found&quot;)
        Just insDec -&gt; makeFieldOpticsForDec lensRules insDec
  where
    getTypeParam (NewtypeInstD _ _ [t] _ _ _) = Just t
    getTypeParam (DataInstD    _ _ [t] _ _ _) = Just t
    getTypeParam _                            = Nothing

    decToType (DataD    _ n _ _ _ _) = return (ConT n)
    decToType (NewtypeD _ n _ _ _ _) = return (ConT n)
    decToType other                  =
        fail (&quot;makeLensesIndexed: decToType failed on: &quot; ++ show other)

-- | Lens for the head of 'NonEmpty'.
--
-- We can't use '_head' because it doesn't work for 'NonEmpty':
-- &lt;https://github.com/ekmett/lens/issues/636#issuecomment-213981096&gt;.
-- Even if we could though, it wouldn't be a lens, only a traversal.
_neHead :: Lens' (NonEmpty a) a
_neHead f (x :| xs) = (:| xs) &lt;$&gt; f x

-- | Lens for the tail of 'NonEmpty'.
_neTail :: Lens' (NonEmpty a) [a]
_neTail f (x :| xs) = (x :|) &lt;$&gt; f xs

-- | Lens for the last element of 'NonEmpty'.
_neLast :: Lens' (NonEmpty a) a
_neLast f (x :| []) = (:| []) &lt;$&gt; f x
_neLast f (x :| xs) = (\y -&gt; x :| unsafeInit xs ++ [y]) &lt;$&gt; f (unsafeLast xs)

instance Lift Byte where
    lift x = let b = toBytes x in [|fromBytes b :: Byte|]

instance FromJSON Byte where
    parseJSON = fmap fromBytes . parseJSON

instance ToJSON Byte where
    toJSON = toJSON . toBytes

-- [SRK-51]: we should try to get this one into safecopy itself though it's
-- unlikely that they will choose a different implementation (if they do
-- choose a different implementation we'll have to write a migration)
--
-- update: made a PR &lt;https://github.com/acid-state/safecopy/pull/47&gt;;
-- remove this instance when the pull request is merged
instance SafeCopy a =&gt; SafeCopy (NonEmpty a) where
    getCopy = contain $ do
        xs &lt;- safeGet
        case nonEmpty xs of
            Nothing -&gt; fail &quot;getCopy@NonEmpty: list can't be empty&quot;
            Just xx -&gt; return xx
    putCopy = contain . safePut . toList
    errorTypeName _ = &quot;NonEmpty&quot;

instance SafeCopy Millisecond where
    getCopy = contain (fromInteger &lt;$&gt; safeGet)
    putCopy = contain . safePut . toInteger
    errorTypeName _ = &quot;Millisecond&quot;

instance SafeCopy Microsecond where
    getCopy = contain (fromInteger &lt;$&gt; safeGet)
    putCopy = contain . safePut . toInteger
    errorTypeName _ = &quot;Microsecond&quot;

-- | A 'zoom' which works in 'MonadState'.
--
-- See &lt;https://github.com/ekmett/lens/issues/580&gt;. You might be surprised
-- but actual 'zoom' doesn't work in any 'MonadState', it only works in a
-- handful of state monads and their combinations defined by 'Zoom'.
zoom'
    :: MonadState s m
    =&gt; LensLike' (Zoomed (State s) a) s t -&gt; StateT t Identity a -&gt; m a
zoom' l = state . runState . zoom l

-- | A 'magnify' which in 'MonadReader'.
magnify'
    :: MonadReader s m
    =&gt; LensLike' (Magnified (Reader s) a) s t -&gt; ReaderT t Identity a -&gt; m a
magnify' l = reader . runReader . magnify l

-- Monad z =&gt; Zoom (StateT s z) (StateT t z) s t
-- Monad z =&gt; Zoom (StateT s z) (StateT t z) s t

----------------------------------------------------------------------------
-- Prettification.
----------------------------------------------------------------------------

-- | Prettify 'Text' message with 'Vivid' color.
colorize :: Color -&gt; Text -&gt; Text
colorize color msg =
    mconcat
        [ toText (setSGRCode [SetColor Foreground Vivid color])
        , msg
        , toText (setSGRCode [Reset])
        ]

-- | Write colored message, do some action, write colored message.
-- Intended for debug only.
withColoredMessages :: MonadIO m =&gt; Color -&gt; Text -&gt; m a -&gt; m a
withColoredMessages color activity action = do
    putText (colorize color $ sformat (&quot;Entered &quot;%stext%&quot;\n&quot;) activity)
    res &lt;- action
    res &lt;$ putText (colorize color $ sformat (&quot;Finished &quot;%stext%&quot;\n&quot;) activity)

-- | Data type to represent waiting strategy for printing warnings
-- if action take too much time.
--
-- [LW-4]: this probably will be moved somewhere from here
data WaitingDelta
    = WaitOnce      Second              -- ^ wait s seconds and stop execution
    | WaitLinear    Second              -- ^ wait s, s * 2, s * 3  , s * 4  , ...      seconds
    | WaitGeometric Microsecond Double  -- ^ wait m, m * q, m * q^2, m * q^3, ... microseconds
    deriving (Show)

-- | Constraint for something that can be logged in parallel with other action.
type CanLogInParallel m = (Mockable Delay m, Mockable Fork m, WithLogger m, Mockable Bracket m)

-- | Run action and print warning if it takes more time than expected.
logWarningLongAction :: CanLogInParallel m =&gt; WaitingDelta -&gt; Text -&gt; m a -&gt; m a
logWarningLongAction delta actionTag action =
    bracket (fork $ waitAndWarn delta) onFinish (const action)
  where
    onFinish logThreadId = do
        killThread logThreadId
        --logDebug (sformat (&quot;Action `&quot;%stext%&quot;` finished&quot;) actionTag)
    printWarning t = logWarning $ sformat (&quot;Action `&quot;%stext%&quot;` took more than &quot;%shown)
                                  actionTag
                                  t

    -- [LW-4]: avoid code duplication somehow (during refactoring)
    waitAndWarn (WaitOnce      s  ) = delay s &gt;&gt; printWarning s
    waitAndWarn (WaitLinear    s  ) = let waitLoop acc = do
                                              delay s
                                              printWarning acc
                                              waitLoop (acc + s)
                                      in waitLoop s
    waitAndWarn (WaitGeometric s q) = let waitLoop acc t = do
                                              delay t
                                              let newAcc = acc + t
                                              let newT   = round $ fromIntegral t * q
                                              printWarning (convertUnit newAcc :: Second)
                                              waitLoop newAcc newT
                                      in waitLoop 0 s

{- Helper functions to avoid dealing with data type -}

-- | Specialization of 'logWarningLongAction' with 'WaitOnce'.
logWarningWaitOnce :: CanLogInParallel m =&gt; Second -&gt; Text -&gt; m a -&gt; m a
logWarningWaitOnce = logWarningLongAction . WaitOnce

-- | Specialization of 'logWarningLongAction' with 'WaiLinear'.
logWarningWaitLinear :: CanLogInParallel m =&gt; Second -&gt; Text -&gt; m a -&gt; m a
logWarningWaitLinear = logWarningLongAction . WaitLinear

-- | Specialization of 'logWarningLongAction' with 'WaitGeometric'
-- with parameter @1.3@. Accepts 'Second'.
logWarningWaitInf :: CanLogInParallel m =&gt; Second -&gt; Text -&gt; m a -&gt; m a
logWarningWaitInf = logWarningLongAction . (`WaitGeometric` 1.3) . convertUnit

-- | Wait random number of 'Microsecond'`s between min and max.
waitRandomInterval
    :: (MonadIO m, Mockable Delay m)
    =&gt; Microsecond -&gt; Microsecond -&gt; m ()
waitRandomInterval minT maxT = do
    interval &lt;-
        (+ minT) . fromIntegral &lt;$&gt;
        liftIO (randomNumber $ fromIntegral $ maxT - minT)
    delay interval

-- | Wait random interval and then perform given action.
runWithRandomIntervals
    :: (MonadIO m, WithLogger m, Mockable Fork m, Mockable Delay m)
    =&gt; Microsecond -&gt; Microsecond -&gt; m () -&gt; m ()
runWithRandomIntervals minT maxT action = do
  waitRandomInterval minT maxT
  action
  runWithRandomIntervals minT maxT action

-- | Like `runWithRandomIntervals`, but performs action immidiatelly
-- at first time.
runWithRandomIntervalsNow
    :: (MonadIO m, WithLogger m, Mockable Fork m, Mockable Delay m)
    =&gt; Microsecond -&gt; Microsecond -&gt; m () -&gt; m ()
runWithRandomIntervalsNow minT maxT action = do
  action
  runWithRandomIntervals minT maxT action

-- TODO remove MonadIO in preference to some `Mockable Random`
-- | Wait random number of 'Microsecond'`s between min and max.
waitRandomInterval'
    :: (MonadIO m, Mockable Delay m)
    =&gt; Microsecond -&gt; Microsecond -&gt; m ()
waitRandomInterval' minT maxT = do
    interval &lt;-
        (+ minT) . fromIntegral &lt;$&gt;
        liftIO (randomNumber $ fromIntegral $ maxT - minT)
    delay interval

-- | Wait random interval and then perform given action.
runWithRandomIntervals'
    :: (MonadIO m, Mockable Delay m)
    =&gt; Microsecond -&gt; Microsecond -&gt; m () -&gt; m ()
runWithRandomIntervals' minT maxT action = do
  waitRandomInterval' minT maxT
  action
  runWithRandomIntervals' minT maxT action

----------------------------------------------------------------------------
-- LRU cache
----------------------------------------------------------------------------

-- | Remove all items from LRU, retaining maxSize property.
clearLRU :: Ord k =&gt; LRU.LRU k v -&gt; LRU.LRU k v
clearLRU = LRU.newLRU . LRU.maxSize

-- [SRK-51]: Probably this instance should be in @safecopy@ library
instance (Ord k, SafeCopy k, SafeCopy v) =&gt;
         SafeCopy (LRU.LRU k v) where
    getCopy = contain $ LRU.fromList &lt;$&gt; safeGet &lt;*&gt; safeGet
    putCopy lru =
        contain $
        do safePut $ LRU.maxSize lru
           safePut $ LRU.toList lru
    errorTypeName _ = &quot;LRU&quot;

-- | Create HashSet from HashMap's keys
getKeys :: HashMap k v -&gt; HashSet k
getKeys = fromMap . void

----------------------------------------------------------------------------
-- Deserialized wrapper
----------------------------------------------------------------------------

-- | See `Pos.Crypto.SerTypes` for details on this types

newtype AsBinary a = AsBinary
    { getAsBinary :: ByteString
    } deriving (Show, Eq, Ord, Hashable)

instance SafeCopy (AsBinary a) where
    getCopy = contain $ AsBinary &lt;$&gt; safeGet
    putCopy = contain . safePut . getAsBinary

class AsBinaryClass a where
  asBinary :: a -&gt; AsBinary a
  fromBinary :: AsBinary a -&gt; Either String a

fromBinaryM :: (AsBinaryClass a, MonadFail m) =&gt; AsBinary a -&gt; m a
fromBinaryM = either fail return . fromBinary

eitherToVerRes :: Either Text a -&gt; VerificationRes
eitherToVerRes (Left errors) = if T.null errors then VerFailure []
                               else VerFailure $ T.split (==';') errors
eitherToVerRes (Right _ )    = VerSuccess

-- | Makes a span on the list, considering tail only. Predicate has
-- list head as first argument. Used to take non-null prefix that
-- depends on the first element.
spanSafe :: (a -&gt; a -&gt; Bool) -&gt; NonEmpty a -&gt; (NonEmpty a, [a])
spanSafe p (x:|xs) = let (a,b) = span (p x) xs in (x:|a,b)

instance IsString s =&gt; MonadFail (Either s) where
    fail = Left . fromString

instance MonadFail (ParsecT s u m) where
    fail = Monad.fail

deriving instance MonadFail m =&gt; MonadFail (LoggerNameBox m)

instance MonadFail m =&gt; MonadFail (ResourceT m) where
    fail = lift . fail

----------------------------------------------------------------------------
-- MVar utilities
----------------------------------------------------------------------------

clearMVar :: MonadIO m =&gt; MVar a -&gt; m ()
clearMVar = liftIO . void . tryTakeMVar

forcePutMVar :: MonadIO m =&gt; MVar a -&gt; a -&gt; m ()
forcePutMVar mvar val = do
    res &lt;- liftIO $ tryPutMVar mvar val
    unless res $ do
        _ &lt;- liftIO $ tryTakeMVar mvar
        forcePutMVar mvar val

-- | Block until value in MVar satisfies given predicate. When value
-- satisfies, it is returned.
readMVarConditional :: (MonadIO m) =&gt; (x -&gt; Bool) -&gt; MVar x -&gt; m x
readMVarConditional predicate mvar = do
    rData &lt;- liftIO . readMVar $ mvar -- first we try to read for optimization only
    if predicate rData then pure rData
    else do
        tData &lt;- liftIO . takeMVar $ mvar -- now take data
        if predicate tData then do -- check again
            _ &lt;- liftIO $ tryPutMVar mvar tData -- try to put taken value
            pure tData
        else
            readMVarConditional predicate mvar

-- | Read until value is equal to stored value comparing by some function.
readUntilEqualMVar
    :: (Eq a, MonadIO m)
    =&gt; (x -&gt; a) -&gt; MVar x -&gt; a -&gt; m x
readUntilEqualMVar f mvar expVal = readMVarConditional ((expVal ==) . f) mvar

-- | Block until value in TVar satisfies given predicate. When value
-- satisfies, it is returned.
readTVarConditional :: (MonadIO m) =&gt; (x -&gt; Bool) -&gt; TVar x -&gt; m x
readTVarConditional predicate tvar = atomically $ do
    res &lt;- readTVar tvar
    if predicate res then pure res
    else retry

-- | Read until value is equal to stored value comparing by some function.
readUntilEqualTVar
    :: (Eq a, MonadIO m)
    =&gt; (x -&gt; a) -&gt; TVar x -&gt; a -&gt; m x
readUntilEqualTVar f tvar expVal = readTVarConditional ((expVal ==) . f) tvar

stubListenerOneMsg
    :: (WithLogger m, Message r, Unpackable p r, Packable p r)
    =&gt; Proxy r -&gt; ListenerAction p m
stubListenerOneMsg p = ListenerActionOneMsg $ \_ _ m -&gt;
                          let _ = m `asProxyTypeOf` p
                           in modifyLoggerName (&lt;&gt; &quot;stub&quot;) $
                                logDebug $ sformat
                                    (&quot;Stub listener (one msg) for &quot;%shown%&quot;: received message&quot;)
                                    (messageName p)

stubListenerConv
    :: (WithLogger m, Message r, Unpackable p r, Packable p Void)
    =&gt; Proxy r -&gt; ListenerAction p m
stubListenerConv p = ListenerActionConversation $ \__nId convActions -&gt;
                          let _ = convActions `asProxyTypeOf` __modP p
                              __modP :: Proxy r -&gt; Proxy (ConversationActions Void r m)
                              __modP _ = Proxy
                           in modifyLoggerName (&lt;&gt; &quot;stub&quot;) $
                                logDebug $ sformat
                                    (&quot;Stub listener (conv) for &quot;%shown%&quot;: received message&quot;)
                                    (messageName p)

withWaitLog :: ( CanLogInParallel m ) =&gt; SendActions p m -&gt; SendActions p m
withWaitLog sendActions = sendActions
    { sendTo = \nodeId msg -&gt;
                  let MessageName mName = messageName' msg
                   in logWarningWaitLinear 4
                        (sformat (&quot;Send &quot;%shown%&quot; to &quot;%shown) mName nodeId) $
                          sendTo sendActions nodeId msg
    , withConnectionTo = \nodeId action -&gt; withConnectionTo sendActions nodeId $ action . withWaitLogConv nodeId
    }

withWaitLogConv
    :: (CanLogInParallel m, Message snd)
    =&gt; NodeId -&gt; ConversationActions snd rcv m -&gt; ConversationActions snd rcv m
withWaitLogConv nodeId conv = conv { send = send', recv = recv' }
  where
    send' msg =
        logWarningWaitLinear 4
          (sformat (&quot;Send &quot;%shown%&quot; to &quot;%shown%&quot; in conversation&quot;) sndMsg nodeId) $
            send conv msg
    recv' =
        logWarningWaitLinear 4
          (sformat (&quot;Recv from &quot;%shown%&quot; in conversation&quot;) nodeId) $
            recv conv
    MessageName sndMsg = messageName $ ((\_ -&gt; Proxy) :: ConversationActions snd rcv m -&gt; Proxy snd) conv

withWaitLogConvL
    :: (CanLogInParallel m, Message rcv)
    =&gt; NodeId -&gt; ConversationActions snd rcv m -&gt; ConversationActions snd rcv m
withWaitLogConvL nodeId conv = conv { send = send', recv = recv' }
  where
    send' msg =
        logWarningWaitLinear 4
          (sformat (&quot;Send to &quot;%shown%&quot; in conversation&quot;) nodeId) $
            send conv msg
    recv' =
        logWarningWaitLinear 4
          (sformat (&quot;Recv &quot;%shown%&quot; from &quot;%shown%&quot; in conversation&quot;) rcvMsg nodeId) $
            recv conv
    MessageName rcvMsg = messageName $ ((\_ -&gt; Proxy) :: ConversationActions snd rcv m -&gt; Proxy rcv) conv

convWithTimeLimit
    :: (Mockable Async m, Mockable Bracket m, Mockable Delay m, WithLogger m)
    =&gt; Microsecond -&gt; NodeId -&gt; ConversationActions snd rcv m -&gt; ConversationActions snd rcv m
convWithTimeLimit timeout nodeId conv = conv { recv = recv' }
      where
        recv' = do
            res &lt;- execWithTimeLimit timeout $ recv conv
            case res of
                Nothing -&gt; do
                    logWarning $
                        sformat (&quot;Recv from &quot;%shown%&quot; in conversation - timeout expired&quot;)
                        nodeId
                    return Nothing
                Just r  -&gt; return r

sendActionsWithTimeLimit
    :: (Mockable Async m, Mockable Bracket m, Mockable Delay m, WithLogger m)
    =&gt; Microsecond -&gt; SendActions p m -&gt; SendActions p m
sendActionsWithTimeLimit timeout sendActions = sendActions
    { withConnectionTo = \nodeId action -&gt;
        withConnectionTo sendActions nodeId $
            action . convWithTimeLimit timeout nodeId
    }


execWithTimeLimit
    :: ( Mockable Async m
       , Mockable Delay m
       , Mockable Bracket m
       )
    =&gt; Microsecond -&gt; m a -&gt; m (Maybe a)
execWithTimeLimit timeout action = do
    promises &lt;- mapM async [ Just &lt;$&gt; action, delay timeout $&gt; Nothing ]
    (_, val) &lt;- waitAny promises `finally` mapM_ cancel promises
    return val

parseIntegralSafe :: Integral a =&gt; Parser a
parseIntegralSafe = fromIntegerSafe . read =&lt;&lt; many1 digit
  where
    fromIntegerSafe :: Integral a =&gt; Integer -&gt; Parser a
    fromIntegerSafe x =
        let res = fromInteger x
        in  if fromIntegral res == x
            then return res
            else fail (&quot;Number is too large: &quot; ++ show x)
</span></pre></body></html>