<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds     #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">-- | Wallet web server.</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span class="hs-operator">.</span><span class="hs-identifier">Methods</span><span>
</span><a name="line-10"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletApplication"><span class="hs-identifier hs-var">walletApplication</span></a><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServer"><span class="hs-identifier hs-var">walletServer</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServeImpl"><span class="hs-identifier hs-var">walletServeImpl</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServerOuts"><span class="hs-identifier hs-var">walletServerOuts</span></a><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Except</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runExceptT</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">get</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runStateT</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Base64</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B64</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Default</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Default</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">def</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">elemIndex</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nub</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span class="hs-operator">.</span><span class="hs-identifier">POSIX</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">POSIXTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getPOSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ords</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wai</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Application</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">API</span><span>                   </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-type">:&lt;|&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">:&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>                                                </span><span class="hs-identifier hs-type">FromHttpApiData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parseUrlPiece</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handler</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Server</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ServerT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">serve</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span><span class="hs-operator">.</span><span class="hs-identifier">Enter</span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-type">:~&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">enter</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">logInfo</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Aeson.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>         </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Communication.Protocol.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span><span class="hs-operator">.</span><span class="hs-identifier">Protocol</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Communication.Types.Protocol.html#OutSpecs"><span class="hs-identifier hs-type">OutSpecs</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Communication.Types.Protocol.html#SendActions"><span class="hs-identifier hs-type">SendActions</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Communication.Protocol.html#hoistSendActions"><span class="hs-identifier hs-var">hoistSendActions</span></a><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Constants.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Constants</span></a><span>                 </span><span class="hs-special">(</span><a href="Pos.Constants.html#curSoftwareVersion"><span class="hs-identifier hs-var">curSoftwareVersion</span></a><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Crypto.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span></a><span>                    </span><span class="hs-special">(</span><a href="Pos.Crypto.Hashing.html#hash"><span class="hs-identifier hs-var">hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Crypto.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span></a><span>                    </span><span class="hs-special">(</span><a href="Pos.Crypto.Signing.html#deterministicKeyGen"><span class="hs-identifier hs-var">deterministicKeyGen</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Signing.html#toPublic"><span class="hs-identifier hs-var">toPublic</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.DHT.Model.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DHT</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span></a><span>                 </span><span class="hs-special">(</span><a href="Pos.DHT.Model.Class.html#getKnownPeers"><span class="hs-identifier hs-var">getKnownPeers</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Slotting.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Slotting</span></a><span>                  </span><span class="hs-special">(</span><a href="Pos.Slotting.Class.html#getSlotDuration"><span class="hs-identifier hs-var">getSlotDuration</span></a><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>                     </span><span class="hs-special">(</span><a href="Pos.Types.Core.html#Address"><span class="hs-identifier hs-type">Address</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Core.html#ChainDifficulty"><span class="hs-identifier hs-type">ChainDifficulty</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Core.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                                </span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#addressF"><span class="hs-identifier hs-var">addressF</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Core.html#coinF"><span class="hs-identifier hs-var">coinF</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>                                                </span><a href="Pos.Types.Address.html#decodeTextAddress"><span class="hs-identifier hs-var">decodeTextAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#makePubKeyAddress"><span class="hs-identifier hs-var">makePubKeyAddress</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>                                                </span><a href="Pos.Types.Core.html#mkCoin"><span class="hs-identifier hs-var">mkCoin</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                      </span><span class="hs-special">(</span><a href="Pos.Util.html#maybeThrow"><span class="hs-identifier hs-var">maybeThrow</span></a><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.BackupPhrase.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">BackupPhrase</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Util.BackupPhrase.html#BackupPhrase"><span class="hs-identifier hs-type">BackupPhrase</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.BackupPhrase.html#keysFromPhrase"><span class="hs-identifier hs-var">keysFromPhrase</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.KeyStorage.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">KeyStorage</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Wallet.KeyStorage.html#KeyError"><span class="hs-identifier hs-type">KeyError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.KeyStorage.html#MonadKeys"><span class="hs-identifier hs-type">MonadKeys</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>                                                </span><a href="Pos.Wallet.KeyStorage.html#addSecretKey"><span class="hs-identifier hs-var">addSecretKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Tx.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Tx</span></a><span>                 </span><span class="hs-special">(</span><a href="Pos.Communication.Specs.html#sendTxOuts"><span class="hs-identifier hs-var">sendTxOuts</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Tx.html#submitTx"><span class="hs-identifier hs-var">submitTx</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Tx.Pure.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Tx</span><span class="hs-operator">.</span><span class="hs-identifier">Pure</span></a><span>            </span><span class="hs-special">(</span><a href="Pos.Wallet.Tx.Pure.html#TxHistoryEntry"><span class="hs-identifier hs-type">TxHistoryEntry</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.WalletMode.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">WalletMode</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Wallet.WalletMode.html#WalletMode"><span class="hs-identifier hs-type">WalletMode</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#applyLastUpdate"><span class="hs-identifier hs-var">applyLastUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#connectedPeers"><span class="hs-identifier hs-var">connectedPeers</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#getTxHistory"><span class="hs-identifier hs-var">getTxHistory</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#localChainDifficulty"><span class="hs-identifier hs-var">localChainDifficulty</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#networkChainDifficulty"><span class="hs-identifier hs-var">networkChainDifficulty</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#waitForUpdate"><span class="hs-identifier hs-var">waitForUpdate</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Api.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Api</span></a><span>            </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Api.html#WalletApi"><span class="hs-identifier hs-type">WalletApi</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Api.html#walletApi"><span class="hs-identifier hs-var">walletApi</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.html#CAddress"><span class="hs-identifier hs-type">CAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CCurrency"><span class="hs-identifier hs-type">CCurrency</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.html#ADA"><span class="hs-identifier hs-var">ADA</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CProfile"><span class="hs-identifier hs-type">CProfile</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CProfile"><span class="hs-identifier hs-type">CProfile</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CTx"><span class="hs-identifier hs-type">CTx</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CTxId"><span class="hs-identifier hs-type">CTxId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CTxMeta"><span class="hs-identifier hs-type">CTxMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CUpdateInfo"><span class="hs-identifier hs-type">CUpdateInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWallet"><span class="hs-identifier hs-type">CWallet</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletInit"><span class="hs-identifier hs-type">CWalletInit</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletMeta"><span class="hs-identifier hs-type">CWalletMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletRedeem"><span class="hs-identifier hs-type">CWalletRedeem</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#NotifyEvent"><span class="hs-identifier hs-type">NotifyEvent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#addressToCAddress"><span class="hs-identifier hs-var">addressToCAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#cAddressToAddress"><span class="hs-identifier hs-var">cAddressToAddress</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#mkCTx"><span class="hs-identifier hs-var">mkCTx</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#mkCTxId"><span class="hs-identifier hs-var">mkCTxId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#toCUpdateInfo"><span class="hs-identifier hs-var">toCUpdateInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#txContainsTitle"><span class="hs-identifier hs-var">txContainsTitle</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#txIdToCTxId"><span class="hs-identifier hs-var">txIdToCTxId</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Error.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Error.html#WalletError"><span class="hs-identifier hs-type">WalletError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Server.Sockets.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span class="hs-operator">.</span><span class="hs-identifier">Sockets</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Server.Sockets.html#MonadWalletWebSockets"><span class="hs-identifier hs-type">MonadWalletWebSockets</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#WalletWebSockets"><span class="hs-identifier hs-type">WalletWebSockets</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#closeWSConnection"><span class="hs-identifier hs-var">closeWSConnection</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#getWalletWebSocketsState"><span class="hs-identifier hs-var">getWalletWebSocketsState</span></a><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#initWSConnection"><span class="hs-identifier hs-var">initWSConnection</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#notify"><span class="hs-identifier hs-var">notify</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#runWalletWS"><span class="hs-identifier hs-var">runWalletWS</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#upgradeApplicationWS"><span class="hs-identifier hs-var">upgradeApplicationWS</span></a><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.State.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">State</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.State.State.html#MonadWalletWebDB"><span class="hs-identifier hs-type">MonadWalletWebDB</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Holder.html#WalletWebDB"><span class="hs-identifier hs-type">WalletWebDB</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#addOnlyNewTxMeta"><span class="hs-identifier hs-var">addOnlyNewTxMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#addUpdate"><span class="hs-identifier hs-var">addUpdate</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Acidic.html#closeState"><span class="hs-identifier hs-var">closeState</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#createWallet"><span class="hs-identifier hs-var">createWallet</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getNextUpdate"><span class="hs-identifier hs-var">getNextUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getPostponeUpdateUntil"><span class="hs-identifier hs-var">getPostponeUpdateUntil</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getProfile"><span class="hs-identifier hs-var">getProfile</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getTxMeta"><span class="hs-identifier hs-var">getTxMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getWalletMeta"><span class="hs-identifier hs-var">getWalletMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Holder.html#getWalletState"><span class="hs-identifier hs-var">getWalletState</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>                                                </span><a href="Pos.Wallet.Web.State.Acidic.html#openState"><span class="hs-identifier hs-var">openState</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#removeNextUpdate"><span class="hs-identifier hs-var">removeNextUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#removePostponeUpdateUntil"><span class="hs-identifier hs-var">removePostponeUpdateUntil</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#removeWallet"><span class="hs-identifier hs-var">removeWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>                                                </span><a href="Pos.Wallet.Web.State.Holder.html#runWalletWebDB"><span class="hs-identifier hs-var">runWalletWebDB</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#setPostponeUpdateUntil"><span class="hs-identifier hs-var">setPostponeUpdateUntil</span></a><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#setProfile"><span class="hs-identifier hs-var">setProfile</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#setWalletMeta"><span class="hs-identifier hs-var">setWalletMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#setWalletTransactionMeta"><span class="hs-identifier hs-var">setWalletTransactionMeta</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Web.Server.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Web.Server.html#serveImpl"><span class="hs-identifier hs-var">serveImpl</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- Top level functionality</span><span>
</span><a name="line-83"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">type</span><span> </span><a name="WalletWebHandler"><a href="Pos.Wallet.Web.Server.Methods.html#WalletWebHandler"><span class="hs-identifier">WalletWebHandler</span></a></a><span> </span><a name="local-6989586621682772467"><a href="#local-6989586621682772467"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#WalletWebSockets"><span class="hs-identifier hs-type">WalletWebSockets</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.State.Holder.html#WalletWebDB"><span class="hs-identifier hs-type">WalletWebDB</span></a><span> </span><a href="#local-6989586621682772467"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">type</span><span> </span><a name="WalletWebMode"><a href="Pos.Wallet.Web.Server.Methods.html#WalletWebMode"><span class="hs-identifier">WalletWebMode</span></a></a><span> </span><a name="local-6989586621682772465"><a href="#local-6989586621682772465"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621682772466"><a href="#local-6989586621682772466"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.WalletMode.html#WalletMode"><span class="hs-identifier hs-type">WalletMode</span></a><span> </span><a href="#local-6989586621682772465"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621682772466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-89"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#MonadWalletWebDB"><span class="hs-identifier hs-type">MonadWalletWebDB</span></a><span> </span><a href="#local-6989586621682772466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-90"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#MonadWalletWebSockets"><span class="hs-identifier hs-type">MonadWalletWebSockets</span></a><span> </span><a href="#local-6989586621682772466"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-91"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">-- | Notifier state (moved here due to `makeLenses` and scoping issues)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">data</span><span> </span><a name="SyncProgress"><a href="Pos.Wallet.Web.Server.Methods.html#SyncProgress"><span class="hs-identifier">SyncProgress</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-95"></a><span>    </span><a name="SyncProgress"><a href="Pos.Wallet.Web.Server.Methods.html#SyncProgress"><span class="hs-identifier">SyncProgress</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="_spLocalCD"><a href="Pos.Wallet.Web.Server.Methods.html#_spLocalCD"><span class="hs-identifier">_spLocalCD</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Core.html#ChainDifficulty"><span class="hs-identifier hs-type">ChainDifficulty</span></a><span>
</span><a name="line-96"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="_spNetworkCD"><a href="Pos.Wallet.Web.Server.Methods.html#_spNetworkCD"><span class="hs-identifier">_spNetworkCD</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Core.html#ChainDifficulty"><span class="hs-identifier hs-type">ChainDifficulty</span></a><span>
</span><a name="line-97"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="_spPeers"><a href="Pos.Wallet.Web.Server.Methods.html#_spPeers"><span class="hs-identifier">_spPeers</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span>
</span><a name="line-98"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''SyncProgress

instance Default SyncProgress where
    def = SyncProgress 0 0 0

walletServeImpl
    :: ( MonadIO m
       , MonadMask m
       , WalletWebMode ssc (WalletWebHandler m))
    =&gt; WalletWebHandler m Application     -- ^ Application getter
    -&gt; FilePath                        -- ^ Path to wallet acid-state
    -&gt; Bool                            -- ^ Rebuild flag for acid-state
    -&gt; Word16                          -- ^ Port to listen
    -&gt; m ()
walletServeImpl app daedalusDbPath dbRebuild port =
    bracket
        ((,) &lt;$&gt; openDB &lt;*&gt; initWS)
        (\(db, conn) -&gt; closeDB db &gt;&gt; closeWS conn)
        $ \(db, conn) -&gt;
            serveImpl (runWalletWebDB db $ runWalletWS conn app) port
  where openDB = openState dbRebuild daedalusDbPath
        closeDB = closeState
        initWS = initWSConnection
        closeWS = closeWSConnection

walletApplication
    :: WalletWebMode ssc m
    =&gt; m (Server WalletApi)
    -&gt; m Application
walletApplication serv = do
    wsConn &lt;- getWalletWebSockets
    serv &gt;&gt;= return . upgradeApplicationWS wsConn . serve walletApi

walletServer
    :: (Monad m, WalletWebMode ssc (WalletWebHandler m))
    =&gt; SendActions m
    -&gt; WalletWebHandler m (WalletWebHandler m :~&gt; Handler)
    -&gt; WalletWebHandler m (Server WalletApi)
walletServer sendActions nat = do
    whenM (isNothing &lt;$&gt; getProfile) $
        createUserProfile &gt;&gt;= setProfile
    ws    &lt;- lift getWalletState
    socks &lt;- getWalletWebSocketsState
    let sendActions' = hoistSendActions
            (lift . lift)
            (runWalletWebDB ws . runWalletWS socks)
            sendActions
    nat &gt;&gt;= launchNotifier
    myCAddresses &gt;&gt;= mapM_ insertAddressMeta
    (`enter` servantHandlers sendActions') &lt;$&gt; nat
  where
    insertAddressMeta cAddr =
        getWalletMeta cAddr &gt;&gt;= createWallet cAddr . fromMaybe def
    createUserProfile = do
        time &lt;- liftIO getPOSIXTime
        pure $ CProfile mempty mempty mempty mempty time mempty mempty

------------------------
-- Notifier
------------------------

-- type SyncState = StateT SyncProgress

-- FIXME: this is really inaficient. Temporary solution
launchNotifier :: WalletWebMode ssc m =&gt; (m :~&gt; Handler) -&gt; m ()
launchNotifier nat = void . liftIO $ mapM startForking
    [ dificultyNotifier
    , updateNotifier
    , updateNotifierUnPostpone
    ]
  where
    cooldownPeriod = 5000000         -- 5 sec
    cooldownPostponePeriod = 5000000 -- 5 sec
    difficultyNotifyPeriod = 500000  -- 0.5 sec
    forkForever action = forkFinally action $ const $ do
        -- TODO: log error
        -- cooldown
        threadDelay cooldownPeriod
        void $ forkForever action
    -- TODO: use Servant.enter here
    -- FIXME: don't ignore errors, send error msg to the socket
    startForking = forkForever . void . runExceptT . unNat nat
    notifier period action = forever $ do
        liftIO $ threadDelay period
        action
    dificultyNotifier = void . flip runStateT def $ notifier difficultyNotifyPeriod $ do
        networkDifficulty &lt;- networkChainDifficulty
        oldNetworkDifficulty &lt;- use spNetworkCD
        when (networkDifficulty /= oldNetworkDifficulty) $ do
            lift $ notify $ NetworkDifficultyChanged networkDifficulty
            spNetworkCD .= networkDifficulty

        localDifficulty &lt;- localChainDifficulty
        oldLocalDifficulty &lt;- use spLocalCD
        when (localDifficulty /= oldLocalDifficulty) $ do
            lift $ notify $ LocalDifficultyChanged localDifficulty
            spLocalCD .= localDifficulty

        peers &lt;- connectedPeers
        oldPeers &lt;- use spPeers
        when (peers /= oldPeers) $ do
            lift $ notify $ ConnectedPeersChanged peers
            spPeers .= peers

    updateNotifier = do
        cps &lt;- waitForUpdate
        addUpdate $ toCUpdateInfo cps
        -- FIXME: a light race condition might happen here.
        -- Probability of hapening is really low and when it happens user might
        -- get notified one more time about an update. Nothing critical.
        whenNothingM_ getPostponeUpdateUntil $
            liftIO getPOSIXTime &gt;&gt;= setPostponeUpdateUntil
    updateNotifierUnPostpone = notifier cooldownPostponePeriod $ do
        mPostpone &lt;- getPostponeUpdateUntil
        time &lt;- liftIO getPOSIXTime
        when (((&lt;) &lt;$&gt; mPostpone &lt;*&gt; pure time) == Just True) $ do
            whenJustM getNextUpdate $
                const $ notify UpdateAvailable
            removePostponeUpdateUntil

    -- historyNotifier :: WalletWebMode ssc m =&gt; m ()
    -- historyNotifier = do
    --     cAddresses &lt;- myCAddresses
    --     forM_ cAddresses $ \cAddress -&gt; do
    --         -- TODO: is reading from acid RAM only (not reading from disk?)
    --         oldHistoryLength &lt;- length . fromMaybe mempty &lt;$&gt; getWalletHistory cAddress
    --         newHistoryLength &lt;- length &lt;$&gt; getHistory cAddress
    --         when (oldHistoryLength /= newHistoryLength) .
    --             notify $ NewWalletTransaction cAddress

walletServerOuts :: OutSpecs
walletServerOuts = sendTxOuts

----------------------------------------------------------------------------
-- Handlers
----------------------------------------------------------------------------

servantHandlers :: WalletWebMode ssc m =&gt;  SendActions m -&gt; ServerT WalletApi m
servantHandlers sendActions =
     (catchWalletError . getWallet)
    :&lt;|&gt;
     catchWalletError getWallets
    :&lt;|&gt;
     (\a b -&gt; catchWalletError . send sendActions a b)
    :&lt;|&gt;
     (\a b c d e -&gt; catchWalletError . sendExtended sendActions a b c d e)
    :&lt;|&gt;
     (\a b -&gt; catchWalletError . getHistory a b )
    :&lt;|&gt;
     (\a b c -&gt; catchWalletError . searchHistory a b c)
    :&lt;|&gt;
     (\a b -&gt; catchWalletError . updateTransaction a b)
    :&lt;|&gt;
     catchWalletError . newWallet
    :&lt;|&gt;
     catchWalletError . restoreWallet
    :&lt;|&gt;
     (\a -&gt; catchWalletError . updateWallet a)
    :&lt;|&gt;
     catchWalletError . deleteWallet
    :&lt;|&gt;
     (\a -&gt; catchWalletError . isValidAddress a)
    :&lt;|&gt;
     catchWalletError getUserProfile
    :&lt;|&gt;
     catchWalletError . updateUserProfile
    :&lt;|&gt;
     catchWalletError . redeemADA sendActions
    :&lt;|&gt;
     catchWalletError nextUpdate
    :&lt;|&gt;
     catchWalletError applyUpdate
    :&lt;|&gt;
     catchWalletError blockchainSlotDuration
    :&lt;|&gt;
     catchWalletError (pure curSoftwareVersion)
    :&lt;|&gt;
     catchWalletError . postponeUpdatesUntil
  where
    -- TODO: can we with Traversable map catchWalletError over :&lt;|&gt;
    -- TODO: add logging on error
    catchWalletError = try

-- getAddresses :: WalletWebMode ssc m =&gt; m [CAddress]
-- getAddresses = map addressToCAddress &lt;$&gt; myAddresses

-- getBalances :: WalletWebMode ssc m =&gt; m [(CAddress, Coin)]
-- getBalances = join $ mapM gb &lt;$&gt; myAddresses
--   where gb addr = (,) (addressToCAddress addr) &lt;$&gt; getBalance addr

getUserProfile :: WalletWebMode ssc m =&gt; m CProfile
getUserProfile = getProfile &gt;&gt;= maybe noProfile pure
  where
    noProfile = throwM $ Internal &quot;No user profile&quot;

updateUserProfile :: WalletWebMode ssc m =&gt; CProfile -&gt; m CProfile
updateUserProfile profile = setProfile profile &gt;&gt; getUserProfile

getWallet :: WalletWebMode ssc m =&gt; CAddress -&gt; m CWallet
getWallet cAddr = do
    balance &lt;- getBalance =&lt;&lt; decodeCAddressOrFail cAddr
    meta &lt;- getWalletMeta cAddr &gt;&gt;= maybe noWallet pure
    pure $ CWallet cAddr balance meta
  where
    noWallet = throwM . Internal $
        sformat (&quot;No wallet with address &quot;%build%&quot; is found&quot;) cAddr

-- TODO: probably poor naming
decodeCAddressOrFail :: WalletWebMode ssc m =&gt; CAddress -&gt; m Address
decodeCAddressOrFail = either wrongAddress pure . cAddressToAddress
  where wrongAddress err = throwM . Internal $
            sformat (&quot;Error while decoding CAddress: &quot;%stext) err

getWallets :: WalletWebMode ssc m =&gt; m [CWallet]
getWallets = join $ mapM getWallet &lt;$&gt; myCAddresses

send :: WalletWebMode ssc m =&gt;  SendActions m -&gt; CAddress -&gt; CAddress -&gt; Coin -&gt; m CTx
send sendActions srcCAddr dstCAddr c =
    sendExtended sendActions srcCAddr dstCAddr c ADA mempty mempty

sendExtended :: WalletWebMode ssc m =&gt; SendActions m -&gt; CAddress -&gt; CAddress -&gt; Coin -&gt; CCurrency -&gt; Text -&gt; Text -&gt; m CTx
sendExtended sendActions srcCAddr dstCAddr c curr title desc = do
    srcAddr &lt;- decodeCAddressOrFail srcCAddr
    dstAddr &lt;- decodeCAddressOrFail dstCAddr
    idx &lt;- getAddrIdx srcAddr
    sks &lt;- getSecretKeys
    let sk = sks !! idx
    na &lt;- getKnownPeers
    etx &lt;- submitTx sendActions sk na [(TxOut dstAddr c, [])]
    case etx of
        Left err -&gt; throwM . Internal $ sformat (&quot;Cannot send transaction: &quot;%stext) err
        Right (tx, _, _) -&gt; do
            logInfo $
                sformat (&quot;Successfully sent &quot;%coinF%&quot; from &quot;%ords%&quot; address to &quot;%addressF)
                c idx dstAddr
            -- TODO: this should be removed in production
            let txHash = hash tx
            () &lt;$ addHistoryTx dstCAddr curr title desc (THEntry txHash tx False Nothing)
            addHistoryTx srcCAddr curr title desc (THEntry txHash tx True Nothing)

getHistory :: WalletWebMode ssc m =&gt; CAddress -&gt; Word -&gt; Word -&gt; m ([CTx], Word)
getHistory cAddr skip limit = do
    history &lt;- getTxHistory =&lt;&lt; decodeCAddressOrFail cAddr
    cHistory &lt;- mapM (addHistoryTx cAddr ADA mempty mempty) history
    pure (paginate cHistory, fromIntegral $ length cHistory)
  where
    paginate = take (fromIntegral limit) . drop (fromIntegral skip)

-- FIXME: is Word enough for length here?
searchHistory :: WalletWebMode ssc m =&gt; CAddress -&gt; Text -&gt; Word -&gt; Word -&gt; m ([CTx], Word)
searchHistory cAddr search skip limit = first (filter $ txContainsTitle search) &lt;$&gt; getHistory cAddr skip limit

addHistoryTx
    :: WalletWebMode ssc m
    =&gt; CAddress
    -&gt; CCurrency
    -&gt; Text
    -&gt; Text
    -&gt; TxHistoryEntry
    -&gt; m CTx
addHistoryTx cAddr curr title desc wtx@(THEntry txId _ _ _) = do
    -- TODO: this should be removed in production
    diff &lt;- networkChainDifficulty
    addr &lt;- decodeCAddressOrFail cAddr
    meta &lt;- CTxMeta curr title desc &lt;$&gt; liftIO getPOSIXTime
    let cId = txIdToCTxId txId
    addOnlyNewTxMeta cAddr cId meta
    meta' &lt;- maybe meta identity &lt;$&gt; getTxMeta cAddr cId
    return $ mkCTx addr diff wtx meta'

newWallet :: WalletWebMode ssc m =&gt; CWalletInit -&gt; m CWallet
newWallet CWalletInit {..} = do
    cAddr &lt;- genSaveAddress cwBackupPhrase
    createWallet cAddr cwInitMeta
    getWallet cAddr

restoreWallet :: WalletWebMode ssc m =&gt; CWalletInit -&gt; m CWallet
restoreWallet CWalletInit {..} = do
    cAddr &lt;- genSaveAddress cwBackupPhrase
    getWalletMeta cAddr &gt;&gt;= maybe (createWallet cAddr cwInitMeta) (const walletExistsError)
    getWallet cAddr
  where
    walletExistsError = throwM $ Internal &quot;Wallet with that mnemonics already exists&quot;

updateWallet :: WalletWebMode ssc m =&gt; CAddress -&gt; CWalletMeta -&gt; m CWallet
updateWallet cAddr wMeta = do
    setWalletMeta cAddr wMeta
    getWallet cAddr

updateTransaction :: WalletWebMode ssc m =&gt; CAddress -&gt; CTxId -&gt; CTxMeta -&gt; m ()
updateTransaction = setWalletTransactionMeta

deleteWallet :: WalletWebMode ssc m =&gt; CAddress -&gt; m ()
deleteWallet cAddr = do
    deleteAddress =&lt;&lt; decodeCAddressOrFail cAddr
    removeWallet cAddr
  where
    deleteAddress addr = do
        idx &lt;- getAddrIdx addr
        deleteSecretKey (fromIntegral idx) `catch` deleteErrHandler
    deleteErrHandler (PrimaryKey err) = throwM . Internal $
        sformat (&quot;Error while deleting wallet: &quot;%stext) err

-- NOTE: later we will have `isValidAddress :: CCurrency -&gt; CAddress -&gt; m Bool` which should work for arbitrary crypto
isValidAddress :: WalletWebMode ssc m =&gt; CCurrency -&gt; Text -&gt; m Bool
isValidAddress ADA sAddr = pure . either (const False) (const True) $ decodeTextAddress sAddr
isValidAddress _ _       = pure False

-- | Get last update info
nextUpdate :: WalletWebMode ssc m =&gt; m CUpdateInfo
nextUpdate = getNextUpdate &gt;&gt;=
             maybeThrow (Internal &quot;No updates available&quot;)

applyUpdate :: WalletWebMode ssc m =&gt; m ()
applyUpdate = removeNextUpdate &gt;&gt; applyLastUpdate

blockchainSlotDuration :: WalletWebMode ssc m =&gt; m Word
blockchainSlotDuration = fromIntegral &lt;$&gt; getSlotDuration

redeemADA :: WalletWebMode ssc m =&gt; SendActions m -&gt; CWalletRedeem -&gt; m CWallet
redeemADA sendActions CWalletRedeem {..} = do
    seedBs &lt;- either
        (\e -&gt; throwM $ Internal (&quot;Seed is invalid base64 string: &quot; &lt;&gt; toText e))
        pure $ B64.decode (encodeUtf8 crSeed)
    (redeemPK, redeemSK) &lt;- maybeThrow (Internal &quot;Seed is not 32-byte long&quot;) $
                            deterministicKeyGen seedBs
    -- new redemption wallet
    walletB &lt;- getWallet crWalletId

    -- send from seedAddress to walletB
    let dstCAddr = cwAddress walletB
    dstAddr &lt;- decodeCAddressOrFail dstCAddr
    redeemBalance &lt;- getBalance $ makePubKeyAddress redeemPK
    na &lt;- getKnownPeers
    etx &lt;- submitTx sendActions redeemSK na [(TxOut dstAddr redeemBalance, [])]
    case etx of
        Left err -&gt; throwM . Internal $ &quot;Cannot send redemption transaction: &quot; &lt;&gt; err
        Right (tx, _, _) -&gt; do
            -- add redemption transaction to the history of new wallet
            () &lt;$ addHistoryTx dstCAddr ADA &quot;ADA redemption&quot; &quot;&quot;
                (THEntry (hash tx) tx False Nothing)
            pure walletB

postponeUpdatesUntil :: WalletWebMode ssc m =&gt; POSIXTime -&gt; m ()
postponeUpdatesUntil = setPostponeUpdateUntil

----------------------------------------------------------------------------
-- Helpers
----------------------------------------------------------------------------

myAddresses :: MonadKeys m =&gt; m [Address]
myAddresses = nub . map (makePubKeyAddress . toPublic) &lt;$&gt; getSecretKeys

myCAddresses :: MonadKeys m =&gt; m [CAddress]
myCAddresses = map addressToCAddress &lt;$&gt; myAddresses

getAddrIdx :: WalletWebMode ssc m =&gt; Address -&gt; m Int
getAddrIdx addr = elemIndex addr &lt;$&gt; myAddresses &gt;&gt;= maybe notFound pure
  where notFound = throwM . Internal $
            sformat (&quot;Address &quot;%addressF%&quot; is not found in wallet&quot;) $ addr

genSaveAddress :: WalletWebMode ssc m =&gt; BackupPhrase -&gt; m CAddress
genSaveAddress ph = addressToCAddress . makePubKeyAddress . toPublic &lt;$&gt; genSaveSK ph
  where
    genSaveSK ph' = do
        let sk = fst $ keysFromPhrase ph'
        addSecretKey sk
        return sk


----------------------------------------------------------------------------
-- Orphan instances
----------------------------------------------------------------------------

instance FromHttpApiData Coin where
    parseUrlPiece = fmap mkCoin . parseUrlPiece

instance FromHttpApiData Address where
    parseUrlPiece = decodeTextAddress

instance FromHttpApiData CAddress where
    parseUrlPiece = fmap addressToCAddress . decodeTextAddress

-- FIXME: unsafe (temporary, will be removed probably in future)
-- we are not checking is receaved Text really vald CTxId
instance FromHttpApiData CTxId where
    parseUrlPiece = pure . mkCTxId

instance FromHttpApiData CCurrency where
    parseUrlPiece = first fromString . readEither . toString
</span></pre></body></html>