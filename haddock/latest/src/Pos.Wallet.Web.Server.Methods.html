<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ConstraintKinds     #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell     #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-comment">-- | Wallet web server.</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span class="hs-operator">.</span><span class="hs-identifier">Methods</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#WalletWebHandler"><span class="hs-identifier hs-type">WalletWebHandler</span></a><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletApplication"><span class="hs-identifier hs-var">walletApplication</span></a><span>
</span><a name="line-13"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServer"><span class="hs-identifier hs-var">walletServer</span></a><span>
</span><a name="line-14"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServeImpl"><span class="hs-identifier hs-var">walletServeImpl</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Methods.html#walletServerOuts"><span class="hs-identifier hs-var">walletServerOuts</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forkFinally</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">catches</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">try</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Catch</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runStateT</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bits</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setBit</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Default</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Default</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">def</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">elemIndex</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">!!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Tagged</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">untag</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span class="hs-operator">.</span><span class="hs-identifier">POSIX</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getPOSIXTime</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Units</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Microsecond</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Second</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">shown</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Formatting</span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">F</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Wai</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Application</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Paths_cardano_sl.html"><span class="hs-identifier">Paths_cardano_sl</span></a><span>              </span><span class="hs-special">(</span><a href="Paths_cardano_sl.html#version"><span class="hs-identifier hs-var">version</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">ReportServer</span><span class="hs-operator">.</span><span class="hs-identifier">Report</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ReportType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RInfo</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Base64</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B64</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">API</span><span>                   </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-type">:&lt;|&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">:&lt;|&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                                                </span><span class="hs-identifier hs-type">FromHttpApiData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parseUrlPiece</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">Multipart</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fdFilePath</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Handler</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Server</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ServerT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">err403</span><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>                                                </span><span class="hs-identifier hs-var">runHandler</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">serve</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Servant</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span><span class="hs-operator">.</span><span class="hs-identifier">Enter</span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-type">:~&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">enter</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Random</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">randomIO</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Wlog</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">logDebug</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logError</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">logInfo</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Base58</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bitcoinAlphabet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">decodeBase58</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Aeson.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>         </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Client.Txp.History.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">History</span></a><span>        </span><span class="hs-special">(</span><a href="Pos.Client.Txp.History.html#TxHistoryAnswer"><span class="hs-identifier hs-type">TxHistoryAnswer</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.History.html#TxHistoryEntry"><span class="hs-identifier hs-type">TxHistoryEntry</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Communication.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Communication</span></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutSpecs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SendActions</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hoistSendActions</span><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>                                                </span><a href="Pos.Communication.Specs.html#sendTxOuts"><span class="hs-identifier hs-var">sendTxOuts</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Communication.Tx.html#submitRedemptionTx"><span class="hs-identifier hs-var">submitRedemptionTx</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Communication.Tx.html#submitTx"><span class="hs-identifier hs-var">submitTx</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Constants.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Constants</span></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">curSoftwareVersion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isDevelopment</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Address</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Coin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addressF</span><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>                                                </span><span class="hs-identifier hs-var">applyCoinPortion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">decodeTextAddress</span><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>                                                </span><span class="hs-identifier hs-var">makePubKeyAddress</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeRedeemAddress</span><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>                                                </span><span class="hs-identifier hs-var">mkCoin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unsafeCoinPortionFromDouble</span><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>                                                </span><span class="hs-identifier hs-var">unsafeSubCoin</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EncryptedSecretKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PassPhrase</span><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>                                                </span><span class="hs-identifier hs-var">aesDecrypt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">deriveAesKeyBS</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                                                </span><span class="hs-identifier hs-var">deriveHDSecretKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyPassphrase</span><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>                                                </span><span class="hs-identifier hs-var">encToPublic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fakeSigner</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hash</span><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>                                                </span><span class="hs-identifier hs-var">noPassEncrypt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">redeemDeterministicKeyGen</span><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>                                                </span><span class="hs-identifier hs-var">redeemToPublic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withSafeSigner</span><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>                                                </span><span class="hs-identifier hs-var">withSafeSigner</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DB</span><span class="hs-operator">.</span><span class="hs-identifier">Limits</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadDBLimits</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">DHT</span><span class="hs-operator">.</span><span class="hs-identifier">Model</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getKnownPeers</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Genesis.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Genesis</span></a><span>                   </span><span class="hs-special">(</span><a href="Pos.Genesis.html#genesisDevSecretKeys"><span class="hs-identifier hs-var">genesisDevSecretKeys</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Reporting</span><span class="hs-operator">.</span><span class="hs-identifier">MemState</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadReportingMem</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">rcReportServers</span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Reporting</span><span class="hs-operator">.</span><span class="hs-identifier">Methods</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sendReport</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sendReportNodeNologs</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Ssc.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>                 </span><span class="hs-special">(</span><a href="Pos.Ssc.Class.Helpers.html#SscHelpersClass"><span class="hs-identifier hs-type">SscHelpersClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Txp.Core.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Txp</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span></a><span>                  </span><span class="hs-special">(</span><a href="Pos.Txp.Core.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Txp.Core.Types.html#TxOutAux"><span class="hs-identifier hs-type">TxOutAux</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybeThrow</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.BackupPhrase.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">BackupPhrase</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Util.BackupPhrase.html#BackupPhrase"><span class="hs-identifier hs-type">BackupPhrase</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.BackupPhrase.html#mkBackupPhrase12"><span class="hs-identifier hs-var">mkBackupPhrase12</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>                                                </span><a href="Pos.Util.BackupPhrase.html#safeKeysFromPhrase"><span class="hs-identifier hs-var">safeKeysFromPhrase</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.BackupPhrase.html#toSeed"><span class="hs-identifier hs-var">toSeed</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.UserSecret.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">UserSecret</span></a><span>           </span><span class="hs-special">(</span><a href="Pos.Util.UserSecret.html#readUserSecret"><span class="hs-identifier hs-var">readUserSecret</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Util.UserSecret.html#usKeys"><span class="hs-identifier hs-var">usKeys</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.KeyStorage.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">KeyStorage</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Wallet.KeyStorage.html#KeyError"><span class="hs-identifier hs-type">KeyError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.KeyStorage.html#MonadKeys"><span class="hs-identifier hs-type">MonadKeys</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>                                                </span><a href="Pos.Wallet.KeyStorage.html#addSecretKey"><span class="hs-identifier hs-var">addSecretKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.WalletMode.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">WalletMode</span></a><span>         </span><span class="hs-special">(</span><a href="Pos.Wallet.WalletMode.html#WalletMode"><span class="hs-identifier hs-type">WalletMode</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#applyLastUpdate"><span class="hs-identifier hs-var">applyLastUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#blockchainSlotDuration"><span class="hs-identifier hs-var">blockchainSlotDuration</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#connectedPeers"><span class="hs-identifier hs-var">connectedPeers</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>                                                </span><a href="Pos.Client.Txp.Balances.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Client.Txp.History.html#getTxHistory"><span class="hs-identifier hs-var">getTxHistory</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#localChainDifficulty"><span class="hs-identifier hs-var">localChainDifficulty</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>                                                </span><a href="Pos.Wallet.WalletMode.html#networkChainDifficulty"><span class="hs-identifier hs-var">networkChainDifficulty</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.WalletMode.html#waitForUpdate"><span class="hs-identifier hs-var">waitForUpdate</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Api.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Api</span></a><span>            </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Api.html#WalletApi"><span class="hs-identifier hs-type">WalletApi</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Api.html#walletApi"><span class="hs-identifier hs-var">walletApi</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.ClientTypes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">ClientTypes</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.html#Acc"><span class="hs-identifier hs-type">Acc</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CAccount"><span class="hs-identifier hs-type">CAccount</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CAccountAddress"><span class="hs-identifier hs-type">CAccountAddress</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CAddress"><span class="hs-identifier hs-type">CAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CCurrency"><span class="hs-identifier hs-type">CCurrency</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.ClientTypes.html#ADA"><span class="hs-identifier hs-var">ADA</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CElectronCrashReport"><span class="hs-identifier hs-type">CElectronCrashReport</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CInitialized"><span class="hs-identifier hs-type">CInitialized</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CPassPhrase"><span class="hs-identifier hs-type">CPassPhrase</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CPostVendWalletRedeem"><span class="hs-identifier hs-type">CPostVendWalletRedeem</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CProfile"><span class="hs-identifier hs-type">CProfile</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CProfile"><span class="hs-identifier hs-type">CProfile</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CTx"><span class="hs-identifier hs-type">CTx</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CTxId"><span class="hs-identifier hs-type">CTxId</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CTxMeta"><span class="hs-identifier hs-type">CTxMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CUpdateInfo"><span class="hs-identifier hs-type">CUpdateInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWallet"><span class="hs-identifier hs-type">CWallet</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletAddress"><span class="hs-identifier hs-type">CWalletAddress</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletInit"><span class="hs-identifier hs-type">CWalletInit</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletMeta"><span class="hs-identifier hs-type">CWalletMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletRedeem"><span class="hs-identifier hs-type">CWalletRedeem</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletSet"><span class="hs-identifier hs-type">CWalletSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletSetInit"><span class="hs-identifier hs-type">CWalletSetInit</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#CWalletSetMeta"><span class="hs-identifier hs-type">CWalletSetMeta</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#NotifyEvent"><span class="hs-identifier hs-type">NotifyEvent</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#SyncProgress"><span class="hs-identifier hs-type">SyncProgress</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#WS"><span class="hs-identifier hs-type">WS</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#addressToCAddress"><span class="hs-identifier hs-var">addressToCAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#cAddressToAddress"><span class="hs-identifier hs-var">cAddressToAddress</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#cPassPhraseToPassPhrase"><span class="hs-identifier hs-var">cPassPhraseToPassPhrase</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#mkCCoin"><span class="hs-identifier hs-var">mkCCoin</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#mkCTx"><span class="hs-identifier hs-var">mkCTx</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#mkCTxId"><span class="hs-identifier hs-var">mkCTxId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#passPhraseToCPassPhrase"><span class="hs-identifier hs-var">passPhraseToCPassPhrase</span></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#toCUpdateInfo"><span class="hs-identifier hs-var">toCUpdateInfo</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#txContainsTitle"><span class="hs-identifier hs-var">txContainsTitle</span></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>                                                </span><a href="Pos.Wallet.Web.ClientTypes.html#txIdToCTxId"><span class="hs-identifier hs-var">txIdToCTxId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.ClientTypes.html#walletAddrByAccount"><span class="hs-identifier hs-var">walletAddrByAccount</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Error.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Error</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Error.html#WalletError"><span class="hs-identifier hs-type">WalletError</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.Server.Sockets.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span><span class="hs-operator">.</span><span class="hs-identifier">Sockets</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.Server.Sockets.html#MonadWalletWebSockets"><span class="hs-identifier hs-type">MonadWalletWebSockets</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#WalletWebSockets"><span class="hs-identifier hs-type">WalletWebSockets</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#closeWSConnection"><span class="hs-identifier hs-var">closeWSConnection</span></a><span class="hs-special">,</span><span>
</span><a name="line-106"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#getWalletWebSockets"><span class="hs-identifier hs-var">getWalletWebSockets</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#initWSConnection"><span class="hs-identifier hs-var">initWSConnection</span></a><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>                                                </span><a href="Pos.Wallet.Web.Server.Sockets.html#notify"><span class="hs-identifier hs-var">notify</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#runWalletWS"><span class="hs-identifier hs-var">runWalletWS</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#upgradeApplicationWS"><span class="hs-identifier hs-var">upgradeApplicationWS</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Wallet.Web.State.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Wallet</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">State</span></a><span>          </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.State.State.html#MonadWalletWebDB"><span class="hs-identifier hs-type">MonadWalletWebDB</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Holder.html#WalletWebDB"><span class="hs-identifier hs-type">WalletWebDB</span></a><span class="hs-special">,</span><span>
</span><a name="line-109"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#addAccount"><span class="hs-identifier hs-var">addAccount</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#addOnlyNewTxMeta"><span class="hs-identifier hs-var">addOnlyNewTxMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#addUpdate"><span class="hs-identifier hs-var">addUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-110"></a><span>                                                </span><a href="Pos.Wallet.Web.State.Acidic.html#closeState"><span class="hs-identifier hs-var">closeState</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#createWSet"><span class="hs-identifier hs-var">createWSet</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#createWallet"><span class="hs-identifier hs-var">createWallet</span></a><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#doesAccountExist"><span class="hs-identifier hs-var">doesAccountExist</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getHistoryCache"><span class="hs-identifier hs-var">getHistoryCache</span></a><span class="hs-special">,</span><span>
</span><a name="line-112"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getNextUpdate"><span class="hs-identifier hs-var">getNextUpdate</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getProfile"><span class="hs-identifier hs-var">getProfile</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getTxMeta"><span class="hs-identifier hs-var">getTxMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-113"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getWSetAddresses"><span class="hs-identifier hs-var">getWSetAddresses</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getWSetMeta"><span class="hs-identifier hs-var">getWSetMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-114"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getWalletAccounts"><span class="hs-identifier hs-var">getWalletAccounts</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#getWalletAddresses"><span class="hs-identifier hs-var">getWalletAddresses</span></a><span class="hs-special">,</span><span>
</span><a name="line-115"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#getWalletMeta"><span class="hs-identifier hs-var">getWalletMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Holder.html#getWalletState"><span class="hs-identifier hs-var">getWalletState</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Acidic.html#openState"><span class="hs-identifier hs-var">openState</span></a><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#removeAccount"><span class="hs-identifier hs-var">removeAccount</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#removeNextUpdate"><span class="hs-identifier hs-var">removeNextUpdate</span></a><span class="hs-special">,</span><span>
</span><a name="line-117"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#removeWSet"><span class="hs-identifier hs-var">removeWSet</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#removeWallet"><span class="hs-identifier hs-var">removeWallet</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.Holder.html#runWalletWebDB"><span class="hs-identifier hs-var">runWalletWebDB</span></a><span class="hs-special">,</span><span>
</span><a name="line-118"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#setProfile"><span class="hs-identifier hs-var">setProfile</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#setWalletMeta"><span class="hs-identifier hs-var">setWalletMeta</span></a><span class="hs-special">,</span><span>
</span><a name="line-119"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#setWalletTransactionMeta"><span class="hs-identifier hs-var">setWalletTransactionMeta</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#testReset"><span class="hs-identifier hs-var">testReset</span></a><span class="hs-special">,</span><span>
</span><a name="line-120"></a><span>                                                </span><a href="Pos.Wallet.Web.State.State.html#updateHistoryCache"><span class="hs-identifier hs-var">updateHistoryCache</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Web.Server.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Web</span><span class="hs-operator">.</span><span class="hs-identifier">Server</span></a><span>                </span><span class="hs-special">(</span><a href="Pos.Web.Server.html#serveImpl"><span class="hs-identifier hs-var">serveImpl</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- Top level functionality</span><span>
</span><a name="line-125"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">type</span><span> </span><a name="WalletWebHandler"><a href="Pos.Wallet.Web.Server.Methods.html#WalletWebHandler"><span class="hs-identifier">WalletWebHandler</span></a></a><span> </span><a name="local-6989586621682021699"><a href="#local-6989586621682021699"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#WalletWebSockets"><span class="hs-identifier hs-type">WalletWebSockets</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Wallet.Web.State.Holder.html#WalletWebDB"><span class="hs-identifier hs-type">WalletWebDB</span></a><span> </span><a href="#local-6989586621682021699"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">type</span><span> </span><a name="WalletWebMode"><a href="Pos.Wallet.Web.Server.Methods.html#WalletWebMode"><span class="hs-identifier">WalletWebMode</span></a></a><span> </span><a name="local-6989586621682021697"><a href="#local-6989586621682021697"><span class="hs-identifier">ssc</span></a></a><span> </span><a name="local-6989586621682021698"><a href="#local-6989586621682021698"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-130"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Pos.Wallet.WalletMode.html#WalletMode"><span class="hs-identifier hs-type">WalletMode</span></a><span> </span><a href="#local-6989586621682021697"><span class="hs-identifier hs-type">ssc</span></a><span> </span><a href="#local-6989586621682021698"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-131"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.State.State.html#MonadWalletWebDB"><span class="hs-identifier hs-type">MonadWalletWebDB</span></a><span> </span><a href="#local-6989586621682021698"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-132"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadDBLimits</span><span> </span><a href="#local-6989586621682021698"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-133"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Pos.Wallet.Web.Server.Sockets.html#MonadWalletWebSockets"><span class="hs-identifier hs-type">MonadWalletWebSockets</span></a><span> </span><a href="#local-6989586621682021698"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-134"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadReportingMem</span><span> </span><a href="#local-6989586621682021698"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-135"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''SyncProgress

walletServeImpl
    :: ( MonadIO m
       , MonadMask m
       , WalletWebMode ssc (WalletWebHandler m))
    =&gt; WalletWebHandler m Application     -- ^ Application getter
    -&gt; FilePath                           -- ^ Path to wallet acid-state
    -&gt; Bool                               -- ^ Rebuild flag for acid-state
    -&gt; Word16                             -- ^ Port to listen
    -&gt; m ()
walletServeImpl app daedalusDbPath dbRebuild port =
    bracket pre post $ \(db, conn) -&gt;
        serveImpl (runWalletWebDB db $ runWalletWS conn app) &quot;127.0.0.1&quot; port
  where
    pre = (,) &lt;$&gt; openDB &lt;*&gt; initWS
    post (db, conn) = closeDB db &gt;&gt; closeWS conn
    openDB = openState dbRebuild daedalusDbPath
    closeDB = closeState
    initWS = putText &quot;walletServeImpl initWsConnection&quot; &gt;&gt; initWSConnection
    closeWS = closeWSConnection

walletApplication
    :: WalletWebMode ssc m
    =&gt; m (Server WalletApi)
    -&gt; m Application
walletApplication serv = do
    wsConn &lt;- getWalletWebSockets
    upgradeApplicationWS wsConn . serve walletApi &lt;$&gt; serv

walletServer
    :: forall ssc m.
       ( SscHelpersClass ssc
       , Monad m
       , MonadIO m
       , WalletWebMode ssc (WalletWebHandler m)
       )
    =&gt; SendActions m
    -&gt; WalletWebHandler m (WalletWebHandler m :~&gt; Handler)
    -&gt; WalletWebHandler m (Server WalletApi)
walletServer sendActions nat = do
    whenM (isNothing &lt;$&gt; getProfile) $
        createUserProfile &gt;&gt;= setProfile
    ws    &lt;- lift getWalletState
    socks &lt;- getWalletWebSockets
    let sendActions' = hoistSendActions
            (lift . lift)
            (runWalletWebDB ws . runWalletWS socks)
            sendActions
    nat &gt;&gt;= launchNotifier
    myRootAddresses &gt;&gt;= mapM_ insertAddressMeta
    addInitialRichAccount sendActions' 0
    (`enter` servantHandlers @ssc sendActions') &lt;$&gt; nat
  where
    insertAddressMeta cAddr = do
        getWSetMeta cAddr &gt;&gt;= createWSet cAddr . fromMaybe def
    createUserProfile = pure $ CProfile mempty

----------------------------------------------------------------------------
-- Notifier
----------------------------------------------------------------------------

-- FIXME: this is really inefficient. Temporary solution
launchNotifier :: WalletWebMode ssc m =&gt; (m :~&gt; Handler) -&gt; m ()
launchNotifier nat =
    void . liftIO $ mapM startForking
        [ dificultyNotifier
        , updateNotifier
        ]
  where
    cooldownPeriod :: Second
    cooldownPeriod = 5

    difficultyNotifyPeriod :: Microsecond
    difficultyNotifyPeriod = 500000  -- 0.5 sec

    -- networkResendPeriod = 10         -- in delay periods
    forkForever action = forkFinally action $ const $ do
        -- TODO: log error
        -- cooldown
        threadDelay cooldownPeriod
        void $ forkForever action
    -- TODO: use Servant.enter here
    -- FIXME: don't ignore errors, send error msg to the socket
    startForking = forkForever . void . runHandler . ($$) nat
    notifier period action = forever $ do
        liftIO $ threadDelay period
        action
    dificultyNotifier = void . flip runStateT def $ notifier difficultyNotifyPeriod $ do
        whenJustM networkChainDifficulty $
            \networkDifficulty -&gt; do
                oldNetworkDifficulty &lt;- use spNetworkCD
                when (Just networkDifficulty /= oldNetworkDifficulty) $ do
                    lift $ notify $ NetworkDifficultyChanged networkDifficulty
                    spNetworkCD .= Just networkDifficulty

        localDifficulty &lt;- localChainDifficulty
        oldLocalDifficulty &lt;- use spLocalCD
        when (localDifficulty /= oldLocalDifficulty) $ do
            lift $ notify $ LocalDifficultyChanged localDifficulty
            spLocalCD .= localDifficulty

        peers &lt;- connectedPeers
        oldPeers &lt;- use spPeers
        when (peers /= oldPeers) $ do
            lift $ notify $ ConnectedPeersChanged peers
            spPeers .= peers

    updateNotifier = do
        cps &lt;- waitForUpdate
        addUpdate $ toCUpdateInfo cps
        logDebug &quot;Added update to wallet storage&quot;
        notify UpdateAvailable

    -- historyNotifier :: WalletWebMode ssc m =&gt; m ()
    -- historyNotifier = do
    --     cAddresses &lt;- addressToCAddress &lt;&lt;$&gt;&gt; myRootAddresses
    --     forM_ cAddresses $ \cAddress -&gt; do
    --         -- TODO: is reading from acid RAM only (not reading from disk?)
    --         oldHistoryLength &lt;- length . fromMaybe mempty &lt;$&gt; getWalletHistory cAddress
    --         newHistoryLength &lt;- length &lt;$&gt; getHistory cAddress
    --         when (oldHistoryLength /= newHistoryLength) .
    --             notify $ NewWalletTransaction cAddress

walletServerOuts :: OutSpecs
walletServerOuts = sendTxOuts

----------------------------------------------------------------------------
-- Handlers
----------------------------------------------------------------------------

servantHandlers
    :: forall ssc m.
       (SscHelpersClass ssc, WalletWebMode ssc m)
    =&gt; SendActions m -&gt; ServerT WalletApi m
servantHandlers sendActions =
     catchWalletError testResetAll
    :&lt;|&gt;

     apiGetWSet
    :&lt;|&gt;
     apiGetWSets
    :&lt;|&gt;
     apiNewWSet
    :&lt;|&gt;
     apiRestoreWSet
    :&lt;|&gt;
     apiImportKey
    :&lt;|&gt;

     apiGetWallet
    :&lt;|&gt;
     apiGetWallets
    :&lt;|&gt;
     apiUpdateWallet
    :&lt;|&gt;
     apiNewWallet
    :&lt;|&gt;
     apiDeleteWallet
    :&lt;|&gt;

     apiNewAccount
    :&lt;|&gt;

     apiIsValidAddress
    :&lt;|&gt;

     apiGetUserProfile
    :&lt;|&gt;
     apiUpdateUserProfile
    :&lt;|&gt;

     apiTxsPayments
    :&lt;|&gt;
     apiTxsPaymentsExt
    :&lt;|&gt;
     apiUpdateTransaction
    :&lt;|&gt;
     apiGetHistory
    :&lt;|&gt;
     apiSearchHistory
    :&lt;|&gt;

     apiNextUpdate
    :&lt;|&gt;
     apiApplyUpdate
    :&lt;|&gt;

     apiRedeemAda
    :&lt;|&gt;
     apiPostVendRedeemAda
    :&lt;|&gt;

     apiReportingInitialized
    :&lt;|&gt;
     apiReportingElectroncrash
    :&lt;|&gt;

     apiSettingsSlotDuration
    :&lt;|&gt;
     apiSettingsSoftwareVersion
    :&lt;|&gt;
     apiSettingsSyncProgress
  where
    -- TODO: can we with Traversable map catchWalletError over :&lt;|&gt;
    -- TODO: add logging on error
    apiGetWSet                  = (catchWalletError . getWSet)
    apiGetWSets                 = catchWalletError getWSets
    apiNewWSet                  = (\a -&gt; catchWalletError . newWSet a)
    apiRestoreWSet              = (\a -&gt; catchWalletError . newWSet a)
    apiImportKey                = catchWalletError . importKey
    apiGetWallet                = catchWalletError . getWallet
    apiGetWallets               = catchWalletError . getWallets
    apiUpdateWallet             = (\a -&gt; catchWalletError . updateWallet a)
    apiNewWallet                = (\a -&gt; catchWalletError . newWallet a)
    apiDeleteWallet             = catchWalletError . deleteWallet
    apiNewAccount               = (\a -&gt; catchWalletError . newAccount a)
    apiIsValidAddress           = (\a -&gt; catchWalletError . isValidAddress a)
    apiGetUserProfile           = catchWalletError getUserProfile
    apiUpdateUserProfile        = catchWalletError . updateUserProfile
    apiTxsPayments              = (\a b c -&gt; catchWalletError . send sendActions a b c)
    apiTxsPaymentsExt           = (\a b c d e f -&gt; catchWalletError . sendExtended sendActions a b c d e f)
    apiUpdateTransaction        = (\a b -&gt; catchWalletError . updateTransaction a b)
    apiGetHistory               = (\a b -&gt; catchWalletError . getHistory @ssc a b)
    apiSearchHistory            = (\a b c d -&gt; catchWalletError . searchHistory @ssc a b c d)
    apiNextUpdate               = catchWalletError nextUpdate
    apiApplyUpdate              = catchWalletError applyUpdate
    apiRedeemAda                = (\a -&gt; catchWalletError . redeemADA sendActions a)
    apiPostVendRedeemAda        = (\a -&gt; catchWalletError . postVendRedeemADA sendActions a)
    apiReportingInitialized     = catchWalletError . reportingInitialized
    apiReportingElectroncrash   = catchWalletError . reportingElectroncrash
    apiSettingsSlotDuration     = catchWalletError (fromIntegral &lt;$&gt; blockchainSlotDuration)
    apiSettingsSoftwareVersion  = catchWalletError (pure curSoftwareVersion)
    apiSettingsSyncProgress     = catchWalletError syncProgress

    catchWalletError            = catchOtherError . try
    catchOtherError             = E.handleAll $ \e -&gt; do
        logError $ sformat (&quot;Uncaught error in wallet method: &quot;%shown) e
        throwM e

-- getAddresses :: WalletWebMode ssc m =&gt; m [CAddress]
-- getAddresses = map addressToCAddress &lt;$&gt; myAddresses

-- getBalances :: WalletWebMode ssc m =&gt; m [(CAddress, Coin)]
-- getBalances = join $ mapM gb &lt;$&gt; myAddresses
--   where gb addr = (,) (addressToCAddress addr) &lt;$&gt; getBalance addr

getUserProfile :: WalletWebMode ssc m =&gt; m CProfile
getUserProfile = getProfile &gt;&gt;= maybeThrow (Internal &quot;No user profile&quot;)

updateUserProfile :: WalletWebMode ssc m =&gt; CProfile -&gt; m CProfile
updateUserProfile profile = setProfile profile &gt;&gt; getUserProfile

getAccountBalance :: WalletWebMode ssc m =&gt; CAccountAddress -&gt; m Coin
getAccountBalance cAccAddr =
    getBalance &lt;=&lt; decodeCAddressOrFail $ caaAddress cAccAddr

getAccount :: WalletWebMode ssc m =&gt; CAccountAddress -&gt; m CAccount
getAccount cAddr = do
    balance &lt;- mkCCoin &lt;$&gt; getAccountBalance cAddr
    return $ CAccount cAddr balance

getWalletAccAddrsOrThrow
    :: WalletWebMode ssc m
    =&gt; CWalletAddress -&gt; m [CAccountAddress]
getWalletAccAddrsOrThrow wCAddr =
    getWalletAccounts wCAddr &gt;&gt;= maybeThrow noWallet
  where
    noWallet =
        Internal $ sformat (&quot;No wallet with address &quot;%build%&quot; found&quot;) wCAddr

getAccounts :: WalletWebMode ssc m =&gt; CWalletAddress -&gt; m [CAccount]
getAccounts = getWalletAccAddrsOrThrow &gt;=&gt; mapM getAccount

getWallet :: WalletWebMode ssc m =&gt; CWalletAddress -&gt; m CWallet
getWallet cAddr = do
    accounts &lt;- getAccounts cAddr
    meta     &lt;- getWalletMeta cAddr &gt;&gt;= maybeThrow noWallet
    pure $ CWallet cAddr meta accounts
  where
    noWallet =
        Internal $ sformat (&quot;No wallet with address &quot;%build%&quot; found&quot;) cAddr

getWSet :: WalletWebMode ssc m =&gt; CAddress WS -&gt; m CWalletSet
getWSet cAddr = do
    meta       &lt;- getWSetMeta cAddr &gt;&gt;= maybeThrow noWSet
    walletsNum &lt;- length &lt;$&gt; getWallets (Just cAddr)
    pure $ CWalletSet cAddr meta walletsNum
  where
    noWSet = Internal $
        sformat (&quot;No wallet set with address &quot;%build%&quot; found&quot;) cAddr

-- TODO: probably poor naming
decodeCAddressOrFail :: WalletWebMode ssc m =&gt; CAddress w -&gt; m Address
decodeCAddressOrFail = either wrongAddress pure . cAddressToAddress
  where wrongAddress err = throwM . Internal $
            sformat (&quot;Error while decoding CAddress: &quot;%stext) err

getWallets :: WalletWebMode ssc m =&gt; Maybe (CAddress WS) -&gt; m [CWallet]
getWallets mCAddr = do
    whenJust mCAddr $ \cAddr -&gt; getWSetMeta cAddr `whenNothingM_` noWSet cAddr
    mapM getWallet . filterByAddr mCAddr =&lt;&lt; getWalletAddresses
  where
    filterByAddr = maybe identity $ \cAddr -&gt;
        filter $ (== cAddr) . cwaWSAddress
    noWSet cAddr = throwM . Internal $
        sformat (&quot;No wallet set with address &quot;%build%&quot; found&quot;) cAddr

getWSets :: WalletWebMode ssc m =&gt; m [CWalletSet]
getWSets = getWSetAddresses &gt;&gt;= mapM getWSet

decodeCPassPhraseOrFail :: WalletWebMode ssc m =&gt; CPassPhrase -&gt; m PassPhrase
decodeCPassPhraseOrFail cpass =
    either (const . throwM $ Internal &quot;Decoding of passphrase failed&quot;) return $
    cPassPhraseToPassPhrase cpass

send
    :: (WalletWebMode ssc m)
    =&gt; SendActions m
    -&gt; CPassPhrase
    -&gt; CWalletAddress
    -&gt; CAddress Acc
    -&gt; Coin
    -&gt; m [CTx]
send sendActions cpass srcCAddr dstCAddr c =
    sendExtended sendActions cpass srcCAddr dstCAddr c ADA mempty mempty

sendExtended
    :: (WalletWebMode ssc m)
    =&gt; SendActions m
    -&gt; CPassPhrase
    -&gt; CWalletAddress
    -&gt; CAddress Acc
    -&gt; Coin
    -&gt; CCurrency
    -&gt; Text
    -&gt; Text
    -&gt; m [CTx]
sendExtended sendActions cpassphrase srcWallet dstAccount c curr title desc = do
    passphrase &lt;- decodeCPassPhraseOrFail cpassphrase
    dstAddr &lt;- decodeCAddressOrFail dstAccount
    allAccounts &lt;- getWalletAccAddrsOrThrow srcWallet
    distr@(remaining, spendings) &lt;- selectSrcAccounts c allAccounts
    logDebug $ buildDistribution distr
    mRemTx &lt;-
        if remaining == mkCoin 0
            then return Nothing
            else do
                remCAddr &lt;- caAddress &lt;$&gt; newAccount cpassphrase srcWallet
                remAddr &lt;- decodeCAddressOrFail $ caaAddress remCAddr
                let remTx = TxOutAux (TxOut remAddr remaining) []
                return $ Just (remTx, remCAddr)
    let mainTxs =
            spendings &lt;&amp;&gt; \(srcAcc, coin) -&gt;
                (srcAcc, TxOutAux (TxOut dstAddr coin) [])
        txsWithRem =
            -- attach remaining money destination account to last selected
            -- source account
            zipWith
                (\(srcAcc, txs) remTxs -&gt; (srcAcc, txs :| remTxs))
                (reverse mainTxs)
                (maybe mempty (one . fst) mRemTx : repeat [])
    na &lt;- getKnownPeers
    forM txsWithRem $ uncurry (sendDo na passphrase)
  where
    selectSrcAccounts
        :: WalletWebMode ssc m
        =&gt; Coin -&gt; [CAccountAddress] -&gt; m (Coin, [(CAccountAddress, Coin)])
    selectSrcAccounts reqCoins accounts =
        case accounts of
            _
                | reqCoins == mkCoin 0 -&gt;
                    throwM $ Internal &quot;Spending non-positive amount of money!&quot;
            [] -&gt;
                throwM . Internal $
                sformat (&quot;Not enough money (need &quot; %build % &quot; more)&quot;) reqCoins
            acc:accs -&gt; do
                balance &lt;- getAccountBalance acc
                case () of
                    _
                        | balance == mkCoin 0 || caaAddress acc == dstAccount -&gt;
                            selectSrcAccounts reqCoins accs
                        | balance &lt; reqCoins -&gt; do
                            let remCoins = reqCoins `unsafeSubCoin` balance
                            ((acc, balance) :) &lt;&lt;$&gt;&gt;
                                selectSrcAccounts remCoins accs
                        | otherwise -&gt;
                            return
                                ( balance `unsafeSubCoin` reqCoins
                                , [(acc, reqCoins)])
    sendDo na passphrase srcAccount txs = do
        sk &lt;- getSKByAccAddr passphrase srcAccount
        srcAccAddr &lt;- decodeCAddressOrFail (caaAddress srcAccount)
        let dstAddrs = toList txs &lt;&amp;&gt; \(TxOutAux (TxOut addr _) _) -&gt; addr
        withSafeSigner sk (return passphrase) $ \mss -&gt; do
            ss  &lt;- mss `whenNothing` throwM (Internal &quot;Passphrase doesn't match&quot;)
            etx &lt;- submitTx sendActions ss na txs
            case etx of
                Left err -&gt;
                    throwM . Internal $
                    sformat (&quot;Cannot send transaction: &quot; %stext) err
                Right (tx, _, _) -&gt; do
                    logInfo $
                        sformat
                            (&quot;Successfully spent money from &quot; %addressF %
                             &quot; address on &quot; %listF &quot;, &quot; addressF)
                            srcAccAddr
                            dstAddrs
                    -- TODO: this should be removed in production
                    let txHash = hash tx
                        addHistory addr isInput =
                            addHistoryTx
                                addr
                                curr
                                title
                                desc
                                (THEntry txHash tx isInput Nothing srcAccAddr)
                    removeAccount srcAccount
                    forM_ dstAddrs $ \dstAddr -&gt;
                        let dstCAddr = addressToCAddress dstAddr
                        in addHistory dstCAddr False
                    addHistory (caaAddress srcAccount) True
    listF separator formatter =
        F.later $ mconcat . intersperse separator . map (F.bprint formatter)
    buildDistribution (remaining, spendings) =
        let entries =
                spendings &lt;&amp;&gt; \(CAccountAddress {..}, coin) -&gt;
                    F.bprint (build % &quot;: &quot; %build) coin caaAddress
            remains = F.bprint (&quot;Remaining: &quot; %build) remaining
        in sformat
               (&quot;Transaction input distribution:\n&quot; %listF &quot;\n&quot; build %
                &quot;\n&quot; %build)
               entries
               remains

getHistory
    :: forall ssc m.
       (SscHelpersClass ssc, WalletWebMode ssc m)
    =&gt; CWalletAddress -&gt; Maybe Word -&gt; Maybe Word -&gt; m ([CTx], Word)
getHistory wAddr skip limit = do
    cAccAddrs &lt;- getWalletAccAddrsOrThrow wAddr
    accAddrs &lt;- forM cAccAddrs (decodeCAddressOrFail . caaAddress)
    cHistory &lt;-
        do (minit, cachedTxs) &lt;- transCache &lt;$&gt; getHistoryCache wAddr

           TxHistoryAnswer {..} &lt;- untag @ssc getTxHistory accAddrs minit

           -- Add allowed portion of result to cache
           let fullHistory = taHistory &lt;&gt; cachedTxs
               lenHistory = length taHistory
               cached = drop (lenHistory - taCachedNum) taHistory
           unless (null cached) $
               updateHistoryCache
                   wAddr
                   taLastCachedHash
                   taCachedUtxo
                   (cached &lt;&gt; cachedTxs)

           forM fullHistory $ \thEntry@THEntry {..} -&gt;
               let srcCAddr = addressToCAddress _thInputAddr
               in addHistoryTx srcCAddr ADA mempty mempty thEntry
    pure (paginate cHistory, fromIntegral $ length cHistory)
  where
    paginate = take defaultLimit . drop defaultSkip
    defaultLimit = (fromIntegral $ fromMaybe 100 limit)
    defaultSkip = (fromIntegral $ fromMaybe 0 skip)
    transCache Nothing                = (Nothing, [])
    transCache (Just (hh, utxo, txs)) = (Just (hh, utxo), txs)

-- FIXME: is Word enough for length here?
searchHistory
    :: forall ssc m.
       (SscHelpersClass ssc, WalletWebMode ssc m)
    =&gt; CWalletAddress
    -&gt; Text
    -&gt; Maybe (CAddress Acc)
    -&gt; Maybe Word
    -&gt; Maybe Word
    -&gt; m ([CTx], Word)
searchHistory wAddr search mAccAddr skip limit =
    first (filter fits) &lt;$&gt; getHistory @ssc wAddr skip limit
  where
    fits ctx = txContainsTitle search ctx
            &amp;&amp; maybe True (== ctAccAddress ctx) mAccAddr

addHistoryTx
    :: WalletWebMode ssc m
    =&gt; CAddress Acc
    -&gt; CCurrency
    -&gt; Text
    -&gt; Text
    -&gt; TxHistoryEntry
    -&gt; m CTx
addHistoryTx cAddr curr title desc wtx@THEntry{..} = do
    -- TODO: this should be removed in production
    diff &lt;- maybe localChainDifficulty pure =&lt;&lt;
            networkChainDifficulty
    addr &lt;- decodeCAddressOrFail cAddr
    meta &lt;- CTxMeta curr title desc &lt;$&gt; liftIO getPOSIXTime
    let cId = txIdToCTxId _thTxId
    addOnlyNewTxMeta cAddr cId meta
    meta' &lt;- maybe meta identity &lt;$&gt; getTxMeta cAddr cId
    return $ mkCTx addr diff wtx meta'

newAccount :: WalletWebMode ssc m =&gt; CPassPhrase -&gt; CWalletAddress -&gt; m CAccount
newAccount cPassphrase cWAddr = do
    -- check wallet exists
    _ &lt;- getWallet cWAddr

    passphrase &lt;- decodeCPassPhraseOrFail cPassphrase
    cAccAddr &lt;- genUniqueAccountAddress passphrase cWAddr
    addAccount cAccAddr
    getAccount cAccAddr

newWallet :: WalletWebMode ssc m =&gt; CPassPhrase -&gt; CWalletInit -&gt; m CWallet
newWallet cPassphrase CWalletInit {..} = do
    -- check wallet set exists
    _ &lt;- getWSet cwInitWSetId

    cAddr &lt;- genUniqueWalletAddress cwInitWSetId
    createWallet cAddr cwInitMeta
    () &lt;$ newAccount cPassphrase cAddr
    getWallet cAddr

createWSetSafe
    :: WalletWebMode ssc m
    =&gt; CAddress WS -&gt; CWalletSetMeta -&gt; m CWalletSet
createWSetSafe cAddr wsMeta = do
    wSetExists &lt;- isJust &lt;$&gt; getWSetMeta cAddr
    when wSetExists $
        throwM $ Internal &quot;Wallet set with that mnemonics already exists&quot;
    createWSet cAddr wsMeta
    getWSet cAddr

newWSet :: WalletWebMode ssc m =&gt; CPassPhrase -&gt; CWalletSetInit -&gt; m CWalletSet
newWSet cPassphrase CWalletSetInit {..} = do
    passphrase &lt;- decodeCPassPhraseOrFail cPassphrase
    let CWalletSetMeta {..} = cwsInitMeta
    cAddr &lt;- genSaveRootAddress passphrase cwsBackupPhrase
    createWSetSafe cAddr cwsInitMeta

updateWallet :: WalletWebMode ssc m =&gt; CWalletAddress -&gt; CWalletMeta -&gt; m CWallet
updateWallet cAddr wMeta = do
    setWalletMeta cAddr wMeta
    getWallet cAddr

updateTransaction :: WalletWebMode ssc m =&gt; CAddress Acc -&gt; CTxId -&gt; CTxMeta -&gt; m ()
updateTransaction = setWalletTransactionMeta

deleteWSet :: WalletWebMode ssc m =&gt; CAddress WS -&gt; m ()
deleteWSet wsAddr = do
    wallets &lt;- getWallets (Just wsAddr)
    mapM_ (deleteWallet . cwAddress) wallets
    deleteAddress wsAddr
    removeWSet wsAddr
  where
    deleteAddress addr = do
        idx &lt;- getAddrIdx addr
        deleteSecretKey (fromIntegral idx) `catch` deleteErrHandler
    deleteErrHandler (PrimaryKey err) = throwM . Internal $
        sformat (&quot;Error while deleting wallet set: &quot;%stext) err

deleteWallet :: WalletWebMode ssc m =&gt; CWalletAddress -&gt; m ()
deleteWallet wAddr = do
    mapM_ deleteAccount =&lt;&lt; getWalletAccAddrsOrThrow wAddr
    removeWallet wAddr

deleteAccount :: WalletWebMode ssc m =&gt; CAccountAddress -&gt; m ()
deleteAccount = removeAccount

-- NOTE: later we will have `isValidAddress :: CCurrency -&gt; CAddress -&gt; m Bool` which should work for arbitrary crypto
isValidAddress :: WalletWebMode ssc m =&gt; Text -&gt; CCurrency -&gt; m Bool
isValidAddress sAddr ADA =
    pure . either (const False) (const True) $ decodeTextAddress sAddr
isValidAddress _ _       = pure False

-- | Get last update info
nextUpdate :: WalletWebMode ssc m =&gt; m CUpdateInfo
nextUpdate = getNextUpdate &gt;&gt;=
             maybeThrow (Internal &quot;No updates available&quot;)

applyUpdate :: WalletWebMode ssc m =&gt; m ()
applyUpdate = removeNextUpdate &gt;&gt; applyLastUpdate

redeemADA :: WalletWebMode ssc m =&gt; SendActions m -&gt; CPassPhrase -&gt; CWalletRedeem -&gt; m CTx
redeemADA sendActions cpassphrase CWalletRedeem {..} = do
    seedBs &lt;- maybe invalidBase64 pure
        -- NOTE: this is just safety measure
        $ rightToMaybe (B64.decode crSeed) &lt;|&gt; rightToMaybe (B64.decodeUrl crSeed)
    redeemADAInternal sendActions cpassphrase crWalletId seedBs
  where
    invalidBase64 = throwM . Internal $ &quot;Seed is invalid base64(url) string: &quot; &lt;&gt; crSeed

-- Decrypts certificate based on:
--  * https://github.com/input-output-hk/postvend-app/blob/master/src/CertGen.hs#L205
--  * https://github.com/input-output-hk/postvend-app/blob/master/src/CertGen.hs#L160
postVendRedeemADA :: WalletWebMode ssc m =&gt; SendActions m -&gt; CPassPhrase -&gt; CPostVendWalletRedeem -&gt; m CTx
postVendRedeemADA sendActions cpassphrase CPostVendWalletRedeem {..} = do
    seedEncBs &lt;- maybe invalidBase58 pure
        $ decodeBase58 bitcoinAlphabet $ encodeUtf8 pvSeed
    aesKey &lt;- either invalidMnemonic pure
        $ deriveAesKeyBS &lt;$&gt; toSeed pvBackupPhrase
    seedDecBs &lt;- either decryptionFailed pure
        $ aesDecrypt seedEncBs aesKey
    redeemADAInternal sendActions cpassphrase pvWalletId seedDecBs
  where
    invalidBase58 = throwM . Internal $ &quot;Seed is invalid base58 string: &quot; &lt;&gt; pvSeed
    invalidMnemonic e = throwM . Internal $ &quot;Invalid mnemonic: &quot; &lt;&gt; toText e
    decryptionFailed e = throwM . Internal $ &quot;Decryption failed: &quot; &lt;&gt; show e

redeemADAInternal :: WalletWebMode ssc m =&gt; SendActions m -&gt; CPassPhrase -&gt; CWalletAddress -&gt; ByteString -&gt; m CTx
redeemADAInternal sendActions cpassphrase walletId seedBs = do
    passphrase &lt;- decodeCPassPhraseOrFail cpassphrase
    (_, redeemSK) &lt;- maybeThrow (Internal &quot;Seed is not 32-byte long&quot;) $
                     redeemDeterministicKeyGen seedBs
    -- new redemption wallet
    _ &lt;- getWallet walletId

    let srcAddr = makeRedeemAddress $ redeemToPublic redeemSK
    dstCAddr &lt;- genUniqueAccountAddress passphrase walletId
    dstAddr &lt;- decodeCAddressOrFail $ caaAddress dstCAddr
    na &lt;- getKnownPeers
    etx &lt;- submitRedemptionTx sendActions redeemSK na dstAddr
    case etx of
        Left err -&gt; throwM . Internal $ &quot;Cannot send redemption transaction: &quot; &lt;&gt; err
        Right (tx, _, _) -&gt; do
            -- add redemption transaction to the history of new wallet
            addHistoryTx (caaAddress dstCAddr) ADA &quot;ADA redemption&quot; &quot;&quot;
              (THEntry (hash tx) tx False Nothing srcAddr)

reportingInitialized
    :: forall ssc m.
       WalletWebMode ssc m
    =&gt; CInitialized -&gt; m ()
reportingInitialized cinit = do
    sendReportNodeNologs version (RInfo $ show cinit) `catch` handler
  where
    handler :: SomeException -&gt; m ()
    handler e =
        logError $
        sformat (&quot;Didn't manage to report initialization time &quot;%shown%
                 &quot; because of exception &quot;%shown) cinit e

reportingElectroncrash :: forall ssc m. WalletWebMode ssc m =&gt; CElectronCrashReport -&gt; m ()
reportingElectroncrash celcrash = do
    servers &lt;- view rcReportServers &lt;$&gt; askReportingContext
    errors &lt;- fmap lefts $ forM servers $ \serv -&gt;
        try $ sendReport [fdFilePath $ cecUploadDump celcrash]
                         []
                         (RInfo $ show celcrash)
                         &quot;daedalus&quot;
                         version
                         (toString serv)
    whenNotNull errors $ handler . NE.head
  where
    fmt = (&quot;Didn't manage to report electron crash &quot;%shown%&quot; because of exception &quot;%shown)
    handler :: SomeException -&gt; m ()
    handler e = logError $ sformat fmt celcrash e

rewrapError :: WalletWebMode ssc m =&gt; m a -&gt; m a
rewrapError = flip catches
    [ E.Handler $ \e@(Internal _)    -&gt; throwM e
    , E.Handler $ \(SomeException e) -&gt; throwM . Internal $ show e
    ]

importKey
    :: WalletWebMode ssc m
    =&gt; Text
    -&gt; m CWalletSet
importKey (toString -&gt; fp) = do
    secret &lt;- rewrapError $ readUserSecret fp
    let keys = secret ^. usKeys
    importedWSets &lt;-
        forM keys $ \key -&gt; do
            let addr = makePubKeyAddress $ encToPublic key
                wsAddr = addressToCAddress addr
            createWSetSafe wsAddr def &lt;* addSecretKey key
    maybeThrow noKey $ head importedWSets
  where
    noKey = Internal $ sformat (&quot;No spending key found at &quot; %build) fp

-- This method is a temporal hack.
-- We spend money from /accounts/, which have randomly generated addresses.
-- To create account with some initial amount of money, we create wallet set
-- with @key = some genesis key@, and send half of savings to newly created
-- account.
addInitialRichAccount :: WalletWebMode ssc m =&gt; SendActions m -&gt; Int -&gt; m ()
addInitialRichAccount sendActions keyId =
    when isDevelopment . E.handleAll handler $ do
        key &lt;- maybeThrow noKey (genesisDevSecretKeys ^? ix keyId)
        let enKey = noPassEncrypt key

        let addr = makePubKeyAddress $ encToPublic enKey
            wsAddr = addressToCAddress addr

        balance &lt;- getBalance addr
        let coinsToSend = applyCoinPortion (unsafeCoinPortionFromDouble 0.5) balance

        let cpass  = passPhraseToCPassPhrase emptyPassphrase
            backup = mkBackupPhrase12 $ sformat build &lt;$&gt; &quot;nyan-forever&quot;
            wsMeta = CWalletSetMeta &quot;Precreated wallet set full of money&quot; backup
            wMeta  = def{ cwName = &quot;Initial wallet&quot; }

        deleteWSet wsAddr `catchAll` \_ -&gt; return ()
        _ &lt;- createWSetSafe wsAddr wsMeta
        addSecretKey enKey
        wAddr    &lt;- cwAddress &lt;$&gt; newWallet cpass (CWalletInit wMeta wsAddr)
        accounts &lt;- getAccounts wAddr
        accAddr  &lt;- maybeThrow noAccount . head $ caAddress &lt;$&gt; accounts

        -- send all money from wallet set (corresponds to genesis address)
        -- to its account
        na          &lt;- getKnownPeers
        let signer   = fakeSigner key
        let dstCAddr = caaAddress accAddr
        dstAddr     &lt;- decodeCAddressOrFail dstCAddr
        let tx       = TxOutAux (TxOut dstAddr coinsToSend) []
        etx         &lt;- submitTx sendActions signer na (one tx)
        case etx of
            Left err -&gt;
                throwM . Internal $ sformat (&quot;Cannot send transaction \
                                    \for genesis account: &quot;%stext) err
            Right _  -&gt;
                logDebug $ sformat (&quot;Spent &quot;%build%&quot; from genesis address #&quot;
                           %int) coinsToSend keyId
  where
    noKey = Internal $ sformat (&quot;No genesis key #&quot;%build) keyId
    noAccount = Internal &quot;No account created with wallet creation!&quot;
    handler = logError . sformat (&quot;Creation of init account failed: &quot;%build)

syncProgress :: WalletWebMode ssc m =&gt; m SyncProgress
syncProgress = do
    SyncProgress
    &lt;$&gt; localChainDifficulty
    &lt;*&gt; networkChainDifficulty
    &lt;*&gt; connectedPeers

testResetAll :: WalletWebMode ssc m =&gt; m ()
testResetAll | isDevelopment = deleteAllKeys &gt;&gt; testReset
             | otherwise     = throwM err403
  where
    deleteAllKeys = do
        keyNum &lt;- length &lt;$&gt; getSecretKeys
        replicateM_ keyNum $ deleteSecretKey 0

---------------------------------------------------------------------------
-- Helpers
----------------------------------------------------------------------------

myRootAddresses :: MonadKeys m =&gt; m [CAddress WS]
myRootAddresses =
    addressToCAddress . makePubKeyAddress . encToPublic &lt;&lt;$&gt;&gt; getSecretKeys

getAddrIdx :: WalletWebMode ssc m =&gt; CAddress WS -&gt; m Int
getAddrIdx addr = elemIndex addr &lt;$&gt; myRootAddresses &gt;&gt;= maybeThrow notFound
  where notFound =
          Internal $ sformat (&quot;Address &quot;%build%&quot; is not found in wallet&quot;) addr

getSKByAddr
    :: WalletWebMode ssc m
    =&gt; CAddress WS
    -&gt; m EncryptedSecretKey
getSKByAddr cAddr = do
    idx &lt;- getAddrIdx cAddr
    sks &lt;- getSecretKeys
    let sk = sks !! idx
    return sk

getSKByAccAddr
    :: WalletWebMode ssc m
    =&gt; PassPhrase
    -&gt; CAccountAddress
    -&gt; m EncryptedSecretKey
getSKByAccAddr passphrase accAddr@CAccountAddress {..} = do
    (addr, accKey) &lt;-
        deriveAccountSK passphrase (walletAddrByAccount accAddr) caaAccountIndex
    let accCAddr = addressToCAddress addr
    if accCAddr /= caaAddress
        then throwM . Internal $ &quot;Account is contradictory!&quot;
        else return accKey

genSaveRootAddress
    :: WalletWebMode ssc m
    =&gt; PassPhrase
    -&gt; BackupPhrase
    -&gt; m (CAddress WS)
genSaveRootAddress passphrase ph =
    addressToCAddress . makePubKeyAddress . encToPublic &lt;$&gt; genSaveSK
  where
    genSaveSK = do
        sk &lt;- either keyFromPhraseFailed (pure . fst)
            $ safeKeysFromPhrase passphrase ph
        addSecretKey sk
        return sk
    keyFromPhraseFailed msg = throwM . Internal $ &quot;Key creation from phrase failed: &quot; &lt;&gt; msg

generateUnique :: (MonadIO m, Random a) =&gt; (a -&gt; m b) -&gt; (b -&gt; m Bool) -&gt; m b
generateUnique generator isDuplicate = loop
  where
    loop = do
        rand  &lt;- liftIO randomIO
        value &lt;- generator rand
        bad   &lt;- isDuplicate value
        if bad
            then loop
            else return value

nonHardenedOnly :: Word32 -&gt; Word32
nonHardenedOnly index = setBit index 31

genUniqueWalletAddress
    :: WalletWebMode ssc m
    =&gt; CAddress WS
    -&gt; m CWalletAddress
genUniqueWalletAddress wsCAddr =
    generateUnique (return . CWalletAddress wsCAddr . nonHardenedOnly)
                   (fmap isJust . getWalletMeta)

genUniqueAccountAddress
    :: WalletWebMode ssc m
    =&gt; PassPhrase
    -&gt; CWalletAddress
    -&gt; m CAccountAddress
genUniqueAccountAddress passphrase wCAddr@CWalletAddress{..} =
    generateUnique (mkAccount . nonHardenedOnly)
                   (doesAccountExist . caaAddress)
  where
    mkAccount caaAccountIndex = do
        (address, _) &lt;- deriveAccountSK passphrase wCAddr caaAccountIndex
        let caaWSAddress   = cwaWSAddress
            caaWalletIndex = cwaIndex
            caaAddress     = addressToCAddress address
        return CAccountAddress{..}

deriveAccountSK
    :: WalletWebMode ssc m
    =&gt; PassPhrase
    -&gt; CWalletAddress
    -&gt; Word32
    -&gt; m (Address, EncryptedSecretKey)
deriveAccountSK passphrase CWalletAddress{..} accIndex = do
    wsKey       &lt;- getSKByAddr cwaWSAddress
    let wKey     = deriveHDSecretKey passphrase wsKey cwaIndex
    let accKey  = deriveHDSecretKey passphrase wKey accIndex
    let accAddr = makePubKeyAddress $ encToPublic accKey
    return (accAddr, accKey)

    -- TODO [CSM-175]: This is true way to generate keypair, since
    -- public key should keep keypath in its attribute.
    -- But for some reason it makes tx sending from generated account fail
    --
    -- Note: perhaps it's not the only place where `createHDAddressH` should be
    -- actually used

    -- let hdPass   = deriveHDPassphrase $ encToPublic wsKey
    -- return $ createHDAddressH passphrase hdPass wKey [cwaIndex] accIndex


----------------------------------------------------------------------------
-- Orphan instances
----------------------------------------------------------------------------

instance FromHttpApiData Coin where
    parseUrlPiece = fmap mkCoin . parseUrlPiece

instance FromHttpApiData Address where
    parseUrlPiece = decodeTextAddress

instance FromHttpApiData (CAddress w) where
    parseUrlPiece = fmap addressToCAddress . decodeTextAddress

instance FromHttpApiData CWalletAddress where
    parseUrlPiece url =
        case T.splitOn &quot;@&quot; url of
            [part1, part2] -&gt; do
                cwaWSAddress &lt;- parseUrlPiece part1
                cwaIndex     &lt;- maybe (Left &quot;Invalid wallet index&quot;) Right $
                                readMaybe $ toString part2
                return CWalletAddress{..}
            _ -&gt; Left &quot;Expected 2 parts separated by '#'&quot;

instance FromHttpApiData CAccountAddress where
    parseUrlPiece url =
        case T.splitOn &quot;@&quot; url of
            [part1, part2, part3, part4] -&gt; do
                caaWSAddress    &lt;- parseUrlPiece part1
                caaWalletIndex  &lt;- maybe (Left &quot;Invalid wallet index&quot;) Right $
                                   readMaybe $ toString part2
                caaAccountIndex &lt;- maybe (Left &quot;Invalid account index&quot;) Right $
                                   readMaybe $ toString part3
                caaAddress      &lt;- parseUrlPiece part4
                return CAccountAddress{..}
            _ -&gt; Left &quot;Expected 4 parts separated by '#'&quot;

-- FIXME: unsafe (temporary, will be removed probably in future)
-- we are not checking is receaved Text really vald CTxId
instance FromHttpApiData CTxId where
    parseUrlPiece = pure . mkCTxId

instance FromHttpApiData CCurrency where
    parseUrlPiece = first fromString . readEither . toString

instance FromHttpApiData CPassPhrase where
    parseUrlPiece = pure . CPassPhrase
</span></pre></body></html>